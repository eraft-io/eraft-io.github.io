<!DOCTYPE html>
<html lang="zh-Hans" data-darkmode="auto">
<head>
  <meta charset="UTF-8">
  <title>eraftå¼€å‘ç»„ - è§£è¯»å›½å¤–ä¼˜è´¨è®¡ç®—æœºè¯¾ç¨‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./heti.css">
  <link rel="stylesheet" href="./index.css">
  <link rel="icon" href="./favicon.svg">
</head>
<body>
  <main class="container">
    <article class="article heti heti--classic">
        <h1 class="article__title">eraft ç²¾è§£è¯¾ç¨‹</h1>
        <blockquote>

        æˆ‘ä»¬å›¢é˜Ÿè‡´åŠ›äºè§£è¯»å›½å¤–ä¼˜ç§€çš„åˆ†å¸ƒå¼å­˜å‚¨ç›¸å…³å¼€æºè¯¾ç¨‹ï¼Œä¸‹é¢æ˜¯è¯¾ç¨‹ä½“ç³»å›¾
        æˆ‘ä»¬å§‹ç»ˆåšä¿¡ä¼˜ç§€çš„æœ¬ç§‘æ•™å­¦ä¸åº”è¯¥æ˜¯ç…§æœ¬å®£ç§‘ä»¥åŠåº”ä»˜è€ƒè¯•ï¼Œä¸€é—¨ä¼˜ç§€çš„è¯¾ç¨‹ï¼Œåº”è¯¥å…·å¤‡è®©å­¦ç”Ÿå­¦ä¼šæ€è€ƒã€åŠ¨æ‰‹å®è·µã€æ‰¾åˆ°é—®é¢˜ã€åå¤è¯•é”™ã€å¹¶è§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼ŒåŒæ—¶åº”è¯¥å°½é‡ç”¨æœ€ç›´ç™½ï¼Œæœ€ç®€å•çš„è¯­è¨€ä¼ è¾¾å…³é”®çš„çŸ¥è¯†ç‚¹ã€‚ä½œä¸ºè®¡ç®—æœºå·¥ä¸šç•Œçš„å·¥ä½œè€…ï¼Œæˆ‘ç›¸ä¿¡åšè¯¾ç¨‹å’ŒåšæŠ€æœ¯ä¸€æ ·ï¼Œå¹¶ä¸æ˜¯è¶Šå¤æ‚è¶Šå¥½ï¼Œåº”è¯¥å°½é‡çš„è®©è®¾è®¡å‡ºæ¥çš„ä¸œè¥¿ç®€å•åŒ–ã€‚
        å…³æ³¨æˆ‘ä»¬çš„æœ€æ–°åŠ¨æ€ï¼Œæ¬¢è¿å…³æ³¨
         
        <a href="https://www.zhihu.com/people/liu-jie-84-52" target="_blank">https://www.zhihu.com/people/liu-jie-84-52</a>
        æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿã€‚

      </blockquote>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/arch.png" width="40%" style="display: inline-block; margin-bottom: 5%;"/>
      </div>

        <details open>
          <summary></summary>
          <ol>
            <li>
              <a href="#intro">MIT6.824 åˆ†å¸ƒå¼ç³»ç»Ÿç³»åˆ—</a>
              <ul>
                <li><a href="./index.html">ï¼ˆä¸€ï¼‰ä½“éªŒåˆ†å¸ƒå¼KVå­˜å‚¨ç³»ç»Ÿeraftkv </a></li>
                <li><a href="./ebook-ch2.html">ï¼ˆäºŒï¼‰Go è¯­è¨€åŸºç¡€çŸ¥è¯†</a></li>
                <li><a href="./ebook-ch3.html">ï¼ˆä¸‰ï¼‰Raft è®ºæ–‡è§£è¯» </a></li>
                <li><a href="./ebook-ch4.html">ï¼ˆå››ï¼‰æ„å»º Raft åº“                </a></li>
                <li><a href="./ebook-ch5.html">ï¼ˆäº”ï¼‰åŸºäº Raft åº“ï¼Œå®ç°ç®€å•çš„åˆ†å¸ƒå¼ KV ç³»   </a></li>
                <li><a href="./ebook-ch6.html">ï¼ˆå…­ï¼‰Multi-Raft è®¾è®¡ä¸å®ç°   </a></li>
                <li><a href="./ebook-ch7.html">ï¼ˆä¸ƒï¼‰åˆ†å¸ƒå¼äº‹åŠ¡åˆæ¢   </a></li>
              </ul>
            </li>
          </ol>
        </details>

      <h2 id="intro"> MIT åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆå››ï¼‰æ„å»º Raft åº“   <a class="anchor" href="#intro">#</a></h2>

      <h3>
        æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡
      </h3>

      <p>
        æˆ‘ä»¬ä¸Šä¸€ç« èŠ‚è®²äº† Raft ç®—æ³•çš„ä¸»è¦å†…å®¹ï¼Œç°åœ¨æˆ‘ä»¬è¦ä»£ç å®ç°å®ƒä»¬äº†ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦æŠ½è±¡å‡ºæˆ‘ä»¬éœ€è¦çš„æ•°æ®ç»“æ„ã€‚å…ˆæ¥æ¢³ç†ä¸€ä¸‹å¯èƒ½ç”¨åˆ°çš„æ•°æ®ç»“æ„ï¼Œé¦–å…ˆèŠ‚ç‚¹ä¹‹é—´éœ€è¦äº’ç›¸è®¿é—®ï¼Œé‚£æˆ‘ä»¬éœ€è¦å®šä¹‰è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„ç½‘ç»œå®¢æˆ·ç«¯ï¼Œè¿™é‡Œé¢è¦åŒ…å«èŠ‚ç‚¹çš„ id, åœ°å€ï¼Œè¿˜æœ‰ rpc çš„å®¢æˆ·ç«¯ï¼Œæ•´ä¸ªç»“æ„æˆ‘ä»¬æŠ½è±¡ä¸º RaftClientEndï¼Œä¸»è¦æ•°æ®å†…å®¹å¦‚ä¸‹ï¼š
      </p>

      <blockquote>
        <pre>
        type RaftClientEnd struct { <br/>
            id             uint64<br/>
            addr           string<br/>
            raftServiceCli *raftpb.RaftServiceClient  // grpc å®¢æˆ·ç«¯
        }        
    </pre>
      </blockquote>
      <p>
        èŠ‚ç‚¹çŠ¶æ€æˆ‘ä»¬ä¹‹å‰æè¿°çš„æœ‰ä¸‰ç§ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š
      </p>

      <blockquote>
        <pre>
        const (<br/>
	NodeRoleFollower NodeRole = iota<br/>
	NodeRoleCandidate<br/>
	NodeRoleLeader<br/>
    )
</pre>
      </blockquote>
      æˆ‘ä»¬è¦å®Œæˆé€‰ä¸¾æ“ä½œçš„è¯éœ€è¦ä¸¤ä¸ªè¶…æ—¶æ—¶é—´ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Golang time åº“é‡Œé¢çš„ Timer å®ç°ï¼Œå®ƒå¯ä»¥å®šæ—¶çš„ç»™ä¸€ä¸ªé€šé“å‘é€æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å®ç°é€‰ä¸¾è¶…æ—¶å’Œå¿ƒè·³è¶…æ—¶ã€‚

      <blockquote>
        electionTimer    *time.Timer<br/>
heartbeatTimer   *time.Timer<br/>
      </blockquote>
      é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜éœ€è¦è®°å½•å½“å‰èŠ‚ç‚¹çš„ id, å½“å‰çš„ä»»æœŸå·ï¼Œä¸ºè°æŠ•ç¥¨ï¼Œè·å¾—ç¥¨æ•°çš„ç»Ÿè®¡ï¼Œå·²ç»æäº¤çš„æ—¥å¿—ç´¢å¼•å·ï¼Œæœ€å apply åˆ°çŠ¶æ€æœºçš„æ—¥å¿—å·ï¼Œä»¥åŠèŠ‚ç‚¹å¦‚æœæ˜¯ Leader çš„è¯éœ€è¦è®°å½•åˆ°å…¶ä»–èŠ‚ç‚¹å¤åˆ¶æœ€æ–°åŒ¹é…çš„æ—¥å¿—å·ï¼Œè¿™å†™æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š


      <blockquote>

        <pre>
        type Raft struct {<br/>
            mu             sync.RWMutex<br/>
            peers          []*RaftClientEnd // rpc å®¢æˆ·ç«¯<br/>
            me_            int  // è‡ªå·±çš„ id<br/>
            dead           int32 // èŠ‚ç‚¹çš„çŠ¶æ€<br/>
            applyCh        chan *pb.ApplyMsg // apply åç¨‹é€šé“ï¼Œåç¨‹æ¨¡å‹ä¸­ä¼šè®²åˆ°<br/>
            applyCond      *sync.Cond // apply æµç¨‹æ§åˆ¶çš„ä¿¡å·é‡<br/>
            replicatorCond []*sync.Cond // å¤åˆ¶æ“ä½œæ§åˆ¶çš„ä¿¡å·é‡<br/>
            role           NodeRole  // èŠ‚ç‚¹å½“å‰çš„çŠ¶æ€<br/>
            curTerm        int64  // å½“å‰çš„ä»»æœŸ<br/>
            votedFor       int64  // ä¸ºè°æŠ•ç¥¨<br/>
            grantedVotes   int    // å·²ç»è·å¾—çš„ç¥¨æ•° <br/>
            logs           *RaftLog  // æ—¥å¿—ä¿¡æ¯<br/>
            commitIdx      int64     // å·²ç»æäº¤çš„æœ€å¤§çš„æ—¥å¿— id<br/>
            lastApplied    int64     // å·²ç» apply çš„æœ€å¤§æ—¥å¿—çš„ id<br/>
            nextIdx        []int     // åˆ°å…¶ä»–èŠ‚ç‚¹ä¸‹ä¸€ä¸ªåŒ¹é…çš„æ—¥å¿— id ä¿¡æ¯<br/>
            matchIdx       []int     // åˆ°å…¶ä»–èŠ‚ç‚¹å½“å‰åŒ¹é…çš„æ—¥å¿— id ä¿¡æ¯<br/>
        
            leaderId         int64   // é›†ç¾¤ä¸­å½“å‰ Leader èŠ‚ç‚¹çš„ id<br/>
            electionTimer    *time.Timer  // é€‰ä¸¾è¶…æ—¶å®šæ—¶å™¨<br/>
            heartbeatTimer   *time.Timer  // å¿ƒè·³è¶…æ—¶å®šæ—¶å™¨<br/>
            heartBeatTimeout uint64       // å¿ƒè·³è¶…æ—¶æ—¶é—´<br/>
            baseElecTimeout  uint64       // é€‰ä¸¾è¶…æ—¶æ—¶é—´<br/>
        }
    </pre>
      </blockquote>
      é¦–å…ˆç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™éœ€è¦æ„é€  Raft è¿™ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ªæµç¨‹æ˜¯åœ¨ MakeRaft é‡Œé¢å®ç°çš„ï¼Œå®ƒä¸»è¦æ˜¯åˆå§‹åŒ–ä¸ä¸€äº›å˜é‡ï¼Œä¸¤ä¸ªå®šæ—¶å™¨ï¼Œå¹¶å¯åŠ¨ç›¸å…³çš„åç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå¯¹æ¯ä¸ªå¯¹ç«¯èŠ‚ç‚¹å¤åˆ¶æœ‰ Replicator åç¨‹ï¼Œè§¦å‘ä¸¤ä¸ªè¶…æ—¶æ—¶é—´æœ‰ Tick åç¨‹ï¼Œåº”ç”¨å·²ç»æäº¤çš„æ—¥å¿—æœ‰ Applier åç¨‹ã€‚

      <h3>
        åç¨‹æ¨¡å‹
      </h3>
      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/goruntine_model.svg" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
      </div>

      <p>ä¸Šå›¾å±•ç¤ºäº†æˆ‘ä»¬ raftcore é‡Œé¢çš„åç¨‹æ¨¡å‹ï¼Œå½“åº”ç”¨å±‚ææ¡ˆ (propose) åˆ°æ¥ä¹‹åä¸»åç¨‹ä¼šåœ¨æœ¬åœ°è¿½åŠ æ—¥å¿—ï¼Œç„¶åå‘é€ BroadcastAppendï¼Œç„¶ååˆ°å…¶ä»–èŠ‚ç‚¹å¤åˆ¶æ—¥å¿—çš„åç¨‹çš„ç­‰å¾…å°±ä¼šè¢«å”¤é†’ï¼Œå¼€å§‹è¿›è¡Œä¸€è½®çš„çš„å¤åˆ¶ï¼ŒreplicateOneRound æˆåŠŸå¤åˆ¶åŠæ•°èŠ‚ç‚¹æ—¥å¿—ä¹‹åä¼šè§¦å‘ commit, rf.applyCond.Signal() ä¼šå”¤é†’ç­‰å¾…åš Apply æ“ä½œçš„ Applier åç¨‹ã€‚

    </p>

    <p>å¦å¤– Tick åç¨‹ä¼šç›‘å¬ Timer ä¸¤ä¸ªè¶…æ—¶çš„ C é€šé“ä¿¡å·ï¼Œä¸€æ—¦å¿ƒè·³è¶…æ—¶å¹¶ä¸”å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ Leaderï¼Œå°±ä¼šè°ƒç”¨ BroadcastHeartbeat å‘é€å¿ƒè·³ï¼Œå‘å¿ƒè·³çš„æ—¶å€™ä¹Ÿä¼š replicateOneRound å°±å’Œä¸Šè¿°ä¸€æ ·ï¼Œå¦‚æœæˆåŠŸå¤åˆ¶åŠæ•°èŠ‚ç‚¹æ—¥å¿—ä¹‹åä¼šè§¦å‘ commit, rf.applyCond.Signal() å°±ä¼šå”¤é†’ç­‰å¾…åš Apply æ“ä½œçš„ Applier åç¨‹ã€‚

    </p>

    <p>
        Applier åç¨‹ apply å®Œæ¶ˆæ¯ä¹‹åä¼šæŠŠ ApplyMsg æ¶ˆæ¯å†™å…¥ rf.applyCh é€šçŸ¥åº”ç”¨å±‚ï¼Œåº”ç”¨å±‚çš„åç¨‹å’Œä»¥ç›‘å¬è¿™ä¸ªé€šé“ï¼Œå¦‚æœæœ‰ ApplyMsg åˆ°æ¥å°±æŠŠå®ƒåº”ç”¨åˆ°çŠ¶æ€æœºã€‚ 
    </p>

    <h3>
        Rpc å®šä¹‰
    </h3>
    eraft çš„ rpc å®šä¹‰æ–‡ä»¶åœ¨ pbs ç›®å½•ä¸‹çš„ raftbasic.proto æ–‡ä»¶ä¸­ï¼Œä¸»è¦çš„æ¶ˆæ¯å¦‚ä¸‹ï¼š

    <br/>
    Entry

    <p>
        è¿™ä¸ªæ˜¯ä¸€ä¸ªæ—¥å¿—æ¡ç›®ä¿¡æ¯è¡¨ç¤ºï¼Œå’Œæˆ‘ä»¬ä¹‹å‰æè¿°çš„ä¸€æ ·ï¼Œå®ƒæœ‰ä»»æœŸå· termï¼Œç´¢å¼•å· index, ä»¥åŠæ“ä½œçš„åºåˆ—åŒ–æ•°æ® data æˆ‘ä»¬ç”¨ä¸€ä¸ªå­—èŠ‚æµæ¥å­˜å‚¨ï¼Œæ—¥å¿—æ¡ç›®æœ‰ä¸¤ç§ç±»å‹ä¸€ç§æ˜¯ Normal æ­£å¸¸æ—¥å¿—ï¼Œå¦ä¸€ç§æ˜¯ ConfChange é…ç½®å˜æ›´çš„æ—¥å¿—ï¼š
    </p>

    <blockquote>
        <pre>
        enum EntryType {<br/>
            EntryNormal = 0;<br/>
            EntryConfChange = 1;<br/>
        }<br/>
        <br/>
        message Entry {<br/>
            EntryType entry_type = 1;<br/>
            uint64    term = 2;<br/>
            int64     index = 3;<br/>
            bytes     data = 4;<br/>
        }
    </pre>
    </blockquote>

    <h3>
        RequestVote ç›¸å…³
    </h3>

    ä¸‹é¢æ˜¯è¯·æ±‚æŠ•ç¥¨ RPC çš„å®šä¹‰ï¼ŒåŸºæœ¬å’Œè®ºæ–‡é‡Œé¢ä¿æŒä¸€è‡´ï¼š
    <br/>
è¯·æ±‚æŠ•ç¥¨é‡Œé¢æœ‰å€™é€‰äººçš„ä»»æœŸå·ï¼Œå®ƒçš„ id ä»¥åŠå®ƒæœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•ä»¥åŠä»»æœŸå·ä¿¡æ¯ã€‚
<br/>
å“åº”é‡Œé¢æœ‰ä¸ªä»»æœŸå·ï¼Œè¿™ä¸ªç”¨æ¥ç»™å€™é€‰äººåœ¨é€‰ä¸¾å¤±è´¥çš„æ—¶å€™æ›´æ–°è‡ªå·±çš„ä»»æœŸï¼Œè¿˜æœ‰ä¸€ä¸ª vote_granted è¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æŠ•ç¥¨æ“ä½œæ˜¯å¦è¢«å¯¹ç«¯èŠ‚ç‚¹æ¥å—ã€‚
<br/>

<blockquote>
    <pre>
    message RequestVoteRequest {<br/>
        int64 term = 1;<br/>
        int64 candidate_id = 2;<br/>
        int64 last_log_index = 3;<br/>
        int64 last_log_term = 4;<br/>
    }<br/>
    
    message RequestVoteResponse {<br/>
        int64 term = 1;<br/>
        bool  vote_granted = 2;<br/>
    }<br/>
    
    service RaftService {<br/>
        //...<br/>
        rpc RequestVote (RequestVoteRequest) returns (RequestVoteResponse) {}<br/>
    }<br/>
</pre>
</blockquote>

<h3>
    AppendEntries ç›¸å…³
</h3>

<p>
    æ—¥å¿—è¿½åŠ æ“ä½œçš„å®šä¹‰å¦‚ä¸‹ï¼ŒåŸºæœ¬ä¹Ÿå’Œè®ºæ–‡é‡Œé¢ä¸€è‡´ï¼š
</p>

<p>
    è¯·æ±‚é‡Œé¢æœ‰ Leader çš„ä»»æœŸï¼Œid ï¼ˆç”¨æ¥å‘Šè¯‰ follower, è¿™æ · client è®¿é—®äº† follower ä¹‹åå¯ä»¥è¢«å‘ŠçŸ¥ leader èŠ‚ç‚¹æ˜¯å“ªä¸ªï¼‰ï¼Œ prev_log_index è¡¨ç¤ºæ¶ˆæ¯é‡Œé¢å°†è¦åŒæ­¥çš„ç¬¬ä¸€æ¡æ—¥å¿—å‰ä¸€æ¡æ—¥å¿—çš„çš„ç´¢å¼•ä¿¡æ¯ï¼Œprev_log_term æ˜¯å®ƒçš„ä»»æœŸä¿¡æ¯ï¼Œleader_commit åˆ™æ˜¯ leader çš„ commit å· (å¯ä»¥ç”¨æ¥å‘¨çŸ¥ follower èŠ‚ç‚¹å½“å‰çš„ commit è¿›åº¦)ï¼Œentries è¡¨ç¤ºæ—¥å¿—æ¡ç›®ä¿¡æ¯ã€‚
</p>

<p>
    å“åº”é‡Œé¢ term ç”¨æ¥å‘Šè¯‰ leader æ˜¯å¦å‡ºæ–°çš„ä»»æœŸçš„æ¶ˆæ¯ï¼Œå¯ä»¥ç”¨æ¥æ›´æ–° leader çš„ä»»æœŸå·ï¼Œsuccess è¡¨ç¤ºæ—¥å¿—è¿½åŠ æ“ä½œæ˜¯å¦æˆåŠŸï¼Œconflict_index ç”¨æ¥è®°å½•å†²çªæ—¥å¿—çš„ç´¢å¼•å·ï¼Œconflict_term ç”¨æ¥è®°å½•å†²çªæ—¥å¿—çš„ä»»æœŸå·ã€‚ 
</p>

<blockquote>

    <pre>
message AppendEntriesRequest {<br/>
    int64    term = 1;<br/>
    int64    leader_id = 2;<br/>
    int64    prev_log_index = 3;<br/>
    int64    prev_log_term = 4;<br/>
    int64    leader_commit = 5;<br/>
    repeated Entry entries = 6;<br/>
}<br/>

message AppendEntriesResponse {<br/>
    int64  term = 1;<br/>
    bool  success = 2;<br/>
    int64 conflict_index = 3;<br/>
    int64 conflict_term = 4;<br/>
}<br/>


service RaftService {<br/>
    //...<br/>
    rpc AppendEntries (AppendEntriesRequest) returns (AppendEntriesResponse) {}<br/>
}<br/>
</pre>
</blockquote>

<h3>
    Leader é€‰ä¸¾å®ç°åˆ†æ
</h3>

<p>
    Raft å®˜ç½‘æä¾›äº†ä¸€ä¸ªç®—æ³•çš„åŠ¨æ€æ¼”ç¤ºåŠ¨ç”»ï¼Œæˆ‘ä»¬å…ˆæ¥ç›´è§‚æ„Ÿå—ä¸‹ Leader é€‰ä¸¾çš„æµç¨‹ï¼Œç„¶åç»“åˆä»£ç ä»‹ç»è¿™ä¸ªæµç¨‹ã€‚
    å¾…ç»­ã€‚ã€‚
</p>

<p>
    é¦–å…ˆ Raft ç®—æ³•ä¸­æœ‰ä¸¤ä¸ªè¶…æ—¶æ—¶é—´ç”¨æ¥æ§åˆ¶ç€ Leader é€‰ä¸¾çš„æµç¨‹ï¼Œé¦–å…ˆæ˜¯é€‰ä¸¾è¶…æ—¶ï¼Œè¿™ä¸ªæ˜¯ Candidate ç­‰å¾…å˜æˆ Leader çš„æ—¶é—´è·¨åº¦ï¼Œå¦‚æœåœ¨è¿™ä¸ªæ—¶é—´å†…è¿˜æ²¡è¢«é€‰æˆ Leader, è¿™ä¸ªè¶…æ—¶å®šæ—¶å™¨ä¼šè¢«é‡ç½®ã€‚æˆ‘ä»¬å‰é¢ä¹Ÿä»‹ç»è¿‡ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´è®¾ç½®ä¸€èˆ¬åœ¨ 150ms åˆ° 300ms ä¹‹é—´ã€‚
</p>

<div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/raft_elec001.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div>  

  <p>
    å¯åŠ¨çš„æ—¶å€™ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„é€‰ä¸¾è¶…å¸‚æ—¶é—´éƒ½è¢«è®¾ç½®åˆ° 150ï½300ms ä¹‹é—´çš„éšæœºå€¼ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¼šç‡å…ˆè¾¾åˆ°è¶…å¸‚æ—¶é—´ï¼Œå¦‚å›¾ A,B,C èŠ‚ç‚¹çš„ C å…ˆè¾¾åˆ°è¶…æ—¶æ—¶é—´ï¼Œå®ƒä» Follower å˜æˆ Candidate, éšåå¼€å§‹æ–°ä»»æœŸçš„é€‰ä¸¾ï¼Œå®ƒä¼šç»™è‡ªå·±æŠ•ä¸€ç¥¨ï¼Œç„¶åå‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€ RequestVoteRequest rpc è¯·æ±‚å®ƒä»¬çš„æŠ•ç¥¨ã€‚
  </p>

  <p>
    1.eraft ä»£ç ä¸­åœ¨å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨å±‚è°ƒç”¨ MakeRaft å‡½æ•°çš„æ—¶å€™ä¼šä¼ å…¥ baseElectionTimeOutMs å’Œ heartbeatTimeOutMsï¼Œ è¿™é‡Œå¿ƒè·³è¶…å¸‚æ—¶é—´æ˜¯å›ºå®šçš„ï¼Œé€‰ä¸¾è¶…æ—¶æ—¶é—´æˆ‘ä»¬ä½¿ç”¨ MakeAnRandomElectionTimeout æ„é€ ç”Ÿæˆäº†ä¸€ä¸ªéšæœºè¶…å¸‚æ—¶é—´ã€‚
  </p>

  <blockquote>
    <pre>
        func MakeRaft(peers []*RaftClientEnd, me int, newdbEng storage_eng.KvStore, applyCh chan *pb.ApplyMsg, heartbeatTimeOutMs uint64, baseElectionTimeOutMs uint64) *Raft {

        ...
        
        heartbeatTimer:   time.NewTimer(time.Millisecond * time.Duration(heartbeatTimeOutMs)),
        electionTimer:    time.NewTimer(time.Millisecond * time.Duration(MakeAnRandomElectionTimeout(int(baseElectionTimeOutMs)))),
        ...
    </pre>
  </blockquote>

  <p>
    2.è¾¾åˆ°é€‰ä¸¾è¶…æ—¶å, èŠ‚ç‚¹ C é¦–å…ˆæŠŠè‡ªå·±çŠ¶æ€æ”¹æˆ Candidateï¼Œç„¶åå¢åŠ è‡ªå·±çš„ä»»æœŸå·ï¼Œå¼€å§‹é€‰ä¸¾ã€‚
  </p>

  <blockquote>
    <pre>
        //
        // Tick raft heart, this ticket trigger raft main flow running
        //
        func (rf *Raft) Tick() {
            for !rf.IsKilled() {
                select {
                case <-rf.electionTimer.C:
                    {
                        rf.SwitchRaftNodeRole(NodeRoleCandidate)
                        rf.IncrCurrentTerm()
                        rf.Election()
                        rf.electionTimer.Reset(time.Millisecond * time.Duration(MakeAnRandomElectionTimeout(int(rf.baseElecTimeout))))
                    }
                ...
            }
        }
    </pre>
  </blockquote>

  <p>
    3.ä¸‹é¢è¿™æ®µä»£ç å°±æ˜¯å‘èµ·é€‰ä¸¾çš„æ ¸å¿ƒé€»è¾‘äº†ï¼Œé¦–å…ˆèŠ‚ç‚¹ IncrGrantedVotes ç»™è‡ªå·±æŠ•ä¸€ç¥¨ï¼Œç„¶åæŠŠ votedFor è®¾ç½®æˆè‡ªå·±ï¼Œä¹‹åæ„é€  RequestVoteRequest rpc è¯·æ±‚ï¼Œå¸¦ä¸Šè‡ªå·±çš„ä»»æœŸå·ï¼ŒCandidateId ä¹Ÿå°±æ˜¯è‡ªå·±çš„ id, æœ€åä¸€ä¸ªæ—¥å¿—æ¡ç›®çš„ç´¢å¼•è¿˜æœ‰ä»»æœŸå·ï¼Œç„¶åæŠŠå½“å‰ Raft çŠ¶æ€æŒä¹…åŒ–ï¼Œå‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å¹¶è¡Œçš„å‘é€ï¼ŒRequestVote è¯·æ±‚
  </p>

  <blockquote>
    <pre>

//
// Election  make a new election
//
func (rf *Raft) Election() {
	fmt.Printf("%d start election \n", rf.me_)
	rf.IncrGrantedVotes()
	rf.votedFor = int64(rf.me_)
	voteReq := &pb.RequestVoteRequest{
		Term:         rf.curTerm,
		CandidateId:  int64(rf.me_),
		LastLogIndex: int64(rf.logs.GetLast().Index),
		LastLogTerm:  int64(rf.logs.GetLast().Term),
	}
	rf.PersistRaftState()
	for _, peer := range rf.peers {
		if int(peer.id) == rf.me_ {
			continue
		}
		go func(peer *RaftClientEnd) {
			PrintDebugLog(fmt.Sprintf("send request vote to %s %s\n", peer.addr, voteReq.String()))

			requestVoteResp, err := (*peer.raftServiceCli).RequestVote(context.Background(), voteReq)
			if err != nil {
				PrintDebugLog(fmt.Sprintf("send request vote to %s failed %v\n", peer.addr, err.Error()))
			}
			...
		}(peer)
	}
}
    </pre>
  </blockquote>

  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/raft_elec002.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div>  
Â <p>
    å¦‚æœ A,B æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™è¿˜æ²¡æœ‰å‘å‡ºæŠ•ç¥¨ï¼ˆå› ä¸ºå®ƒä»¬è¿˜æ²¡è¾¾åˆ°é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼‰ï¼Œå®ƒä»¬å°±ä¼šç»™å€™é€‰äººèŠ‚ç‚¹ C æŠ•ç¥¨, åŒæ—¶é‡è®¾è‡ªå·±çš„é€‰ä¸¾è¶…æ—¶å®šæ—¶å™¨ã€‚
</p>

<p>
    4.eraft å¤„ç†æŠ•ç¥¨è¯·æ±‚çš„ç»†èŠ‚å¦‚ä¸‹, æˆ‘ä»¬ç»“åˆå›¾ä¸­çš„ä¾‹å­åˆ†æä¸‹é¢çš„é€»è¾‘ï¼Œå‡è®¾ A èŠ‚ç‚¹æ­£åœ¨å¤„ç†æ¥è‡ª C çš„æŠ•ç¥¨è¯·æ±‚ï¼Œé‚£ä¹ˆé¦–å…ˆ C çš„ ä»»æœŸå·å¤§äº A çš„, ä»£ç ä¸­ 1 çš„ if åˆ†æ”¯ä¸ä¼šæ‰§è¡Œ, åœ¨ 2 è¿™é‡Œï¼Œ A èŠ‚ç‚¹å‘ç°æ¥è‡ª C çš„è¯·æ±‚æŠ•ç¥¨æ¶ˆæ¯çš„ä»»æœŸå·å¤§äºè‡ªå·±çš„ï¼Œå®ƒä¼šè°ƒç”¨ SwitchRaftNodeRole å˜æˆ Follower èŠ‚ç‚¹, åœ¨å› C æ¶ˆæ¯ä¹‹å‰ï¼Œä»£ç ä¸­ 3 å·ä½ç½® A è°ƒç”¨ electionTimer.Reset é‡è®¾äº†è‡ªå·±çš„é€‰ä¸¾è¶…æ—¶å®šæ—¶å™¨ã€‚
</p>

<blockquote>
    <pre>
     
//
// HandleRequestVote  handle request vote from other node
//
func (rf *Raft) HandleRequestVote(req *pb.RequestVoteRequest, resp *pb.RequestVoteResponse) {
	rf.mu.Lock()
	defer rf.mu.Unlock()
	defer rf.PersistRaftState()

    // 1
	if req.Term < rf.curTerm || (req.Term == rf.curTerm && rf.votedFor != -1 && rf.votedFor != req.CandidateId) {
		resp.Term, resp.VoteGranted = rf.curTerm, false
		return
	}

    // 2 
	if req.Term > rf.curTerm {
		rf.SwitchRaftNodeRole(NodeRoleFollower)
		rf.curTerm, rf.votedFor = req.Term, -1
	}
	
	...
	
	rf.votedFor = req.CandidateId
	
	// 3
	rf.electionTimer.Reset(time.Millisecond * time.Duration(MakeAnRandomElectionTimeout(int(rf.baseElecTimeout))))
	resp.Term, resp.VoteGranted = rf.curTerm, true
}   
    </pre>
</blockquote>

<div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/raft_elec003.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div>  

  <p>
    C æ”¶åˆ°åŠæ•°ç¥¨ä»¥ä¸Šï¼Œä¹Ÿå°±æ˜¯ A, B èŠ‚ç‚¹çš„ä»»æ„ä¸€ä¸ªçš„æŠ•ç¥¨åŠ ä¸Šè‡ªå·±é‚£ä¸€å¼ é€‰ç¥¨ï¼Œå®ƒå°±å˜æˆäº† Leaderï¼Œç„¶ååœæ­¢è‡ªå·±çš„é€‰ä¸¾è¶…æ—¶å®šæ—¶å™¨ã€‚
  </p>

  <p>
    5.C ç»Ÿè®¡ç¥¨æ•°å¤„ç†è¯·æ±‚æŠ•ç¥¨çš„å“åº”å¦‚ä¸‹ï¼Œæ³¨æ„ï¼šè¿™æ®µä»£ç åŠ äº†é”ï¼Œåº”ä¸ºè¿™é‡Œæ¶‰åŠåˆ°å¤šä¸ª Goruntine å»ä¿®æ”¹ rf ä¸­çš„éåŸå­å˜é‡ï¼Œå¦‚æœä¸åŠ é”å¯èƒ½ä¼šå¯¼è‡´é€»è¾‘é”™è¯¯ã€‚ä»£ç ä¸­ 1 å¤„ï¼Œå¦‚æœæ”¶åˆ°æŠ•ç¥¨çš„å“åº” VoteGranted æ˜¯ trueã€‚C å°±ä¼šè°ƒç”¨ IncrGrantedVotes é€’å¢è‡ªå·±æ‹¥æœ‰çš„ç¥¨ä¹¦ï¼Œç„¶å if rf.grantedVotes > len(rf.peers)/2 åˆ¤æ–­æ˜¯å¦æ‹¿åˆ°äº†åŠæ•°ä»¥ä¸Šç¥¨ï¼Œå¦‚æœæ˜¯çš„è°ƒç”¨ SwitchRaftNodeRole åˆ‡æ¢è‡ªå·±çš„çŠ¶æ€ä¸º Leaderï¼Œä¹‹å BroadcastHeartbeat å¹¿æ’­å¿ƒè·³æ¶ˆæ¯ï¼Œå¹¶é‡æ–°è®¾ç½®è‡ªå·±çš„å¾—ç¥¨æ•° grantedVotes ä¸º 0ã€‚
  </p>

  <blockquote>
    <pre>
        if requestVoteResp != nil {
            rf.mu.Lock()
            defer rf.mu.Unlock()
            PrintDebugLog(fmt.Sprintf("send request vote to %s recive -> %s, curterm %d, req term %d", peer.addr, requestVoteResp.String(), rf.curTerm, voteReq.Term))
            if rf.curTerm == voteReq.Term && rf.role == NodeRoleCandidate {
                // 1
                if requestVoteResp.VoteGranted {
                    // success granted the votes
                    PrintDebugLog("I grant vote")
                    rf.IncrGrantedVotes()
                    if rf.grantedVotes > len(rf.peers)/2 {
                        PrintDebugLog(fmt.Sprintf("node %d get majority votes int term %d ", rf.me_, rf.curTerm))
                        rf.SwitchRaftNodeRole(NodeRoleLeader)
                        rf.BroadcastHeartbeat()
                        rf.grantedVotes = 0
                    }
                // 2
                } else if requestVoteResp.Term > rf.curTerm {
                    // request vote reject
                    rf.SwitchRaftNodeRole(NodeRoleFollower)
                    rf.curTerm, rf.votedFor = requestVoteResp.Term, -1
                    rf.PersistRaftState()
                }
            }
        }
    </pre>
  </blockquote>

  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/raft_elec004.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div>  

  æˆ‘ä»¬çŸ¥é“ A,B åœ¨å‰é¢å¤„ç†æŠ•ç¥¨è¯·æ±‚çš„æ—¶å€™åªæ˜¯é‡è®¾çš„è¶…æ—¶å®šæ—¶å™¨ï¼Œé‚£ä¹ˆä¸‡ä¸€å†ä¸€æ¬¡è¶…æ—¶å®šæ—¶å™¨åˆ°è¾¾ï¼Œä¼šä¸ä¼šé‡æ–°å‡ºå‘é€‰ä¸¾ï¼Œç„¶åé™·å…¥é€‰ä¸¾å¾ªç¯å‘¢ï¼Ÿ


  <p>
    ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œæˆ‘ä»¬å‰é¢åªä»‹ç»äº†é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œè¿˜æœ‰ä¸€ä¸ªå¿ƒè·³è¶…æ—¶æ—¶é—´ï¼Œè¿™ä¸ªè¶…æ—¶æ—¶é—´æ¯”é€‰ä¸¾è¶…å¸‚æ—¶é—´çŸ­ï¼Œä¸€èˆ¬æ˜¯é€‰ä¸¾è¶…æ—¶æ—¶é—´çš„ 1/3ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ A, B è¿˜æ²¡åˆ°è¾¾é€‰ä¸¾è¶…æ—¶æ—¶é—´ä¹‹å‰ï¼Œè¿™ä¸ªå¿ƒè·³è¶…å¸‚æ—¶é—´ä¼šå…ˆå‡ºå‘ï¼Œå¦‚æœæ˜¯ Leader èŠ‚ç‚¹çš„è¯ï¼Œå®ƒä¼šç»™é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…ï¼Œå…¶ä»–èŠ‚ç‚¹ (A, B) æ¥å—åˆ°å¿ƒè·³åŒ…ä¹‹å, åˆä¼šé‡è®¾è‡ªå·±çš„é€‰ä¸¾è¶…æ—¶å®šæ—¶å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ Leader C ä¸€ç›´æ­£å¸¸è¿å¿ƒå‘é€å¿ƒè·³åŒ…ï¼Œé‚£ä¹ˆ A,B èŠ‚ç‚¹ä¸å¯èƒ½è§¦å‘é€‰ä¸¾ï¼Œåªæœ‰å½“ Leader C æŒ‚äº†ã€‚A,B èŠ‚ç‚¹æ‰ä¼šå¼€å§‹ä¸‹ä¸€è½®é€‰ä¸¾ã€‚
  </p>

  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/raft_elec005.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div>  

  <h3>
    æ—¥å¿—å¤åˆ¶å®ç°åˆ†æ
  </h3>

  <p>
  ç»è¿‡ä¸Šè¿°çš„é€‰ä¸¾æµç¨‹ï¼Œæˆ‘ä»¬ç°åœ¨å°±æœ‰ä¸€ä¸ªæ‹¥æœ‰ä¸»èŠ‚ç‚¹å’Œå¤šä¸ªä»èŠ‚ç‚¹çš„ç³»ç»Ÿäº†ï¼Œä¸»èŠ‚ç‚¹ä¼šä¸æ–­çš„ç»™ä»èŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯ã€‚ç°åœ¨æˆ‘ä»¬è¦å¼€å§‹è€ƒè™‘å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚äº†ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ“ä½œè¿‡æ¥ï¼Œæˆ‘ä»¬è¿™ä¸ªç³»ç»Ÿæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ
</p>
<p>
é¦–å…ˆï¼ŒRaft è§„å®šåªæœ‰ Leader èŠ‚ç‚¹èƒ½å¤„ç†è¯·æ±‚å†™å…¥ï¼Œå®¢æˆ·ç«¯å‘é€è¯·æ±‚é¦–å…ˆä¼šåˆ°è¾¾ Leader èŠ‚ç‚¹ã€‚
</p>

<p>
åœ¨ eraft åº“ä¸­ç”¨æˆ·è¯·æ±‚åˆ°æ¥å’Œ raft äº¤äº’çš„å…¥å£å‡½æ•°æ˜¯ Proposeï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆä¼šæŸ¥è¯¢å½“å‰èŠ‚ç‚¹çŠ¶æ€ï¼Œåªæœ‰ Leader èŠ‚ç‚¹æ‰èƒ½å¤„ç†ææ¡ˆï¼ˆproposeï¼‰ï¼Œä¹‹åä¼šæŠŠç”¨æˆ·æ“ä½œçš„åºåˆ—åŒ–ä¹‹åçš„ []byte è°ƒç”¨ Append è¿½åŠ åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œä¹‹å BroadcastAppend å°†æ—¥å¿—å†…å®¹å‘é€ç»™é›†ç¾¤ä¸­çš„ Follower èŠ‚ç‚¹ã€‚
</p>

<blockquote>
    <pre>
        //
// Propose the interface to the appplication propose a operation
//

func (rf *Raft) Propose(payload []byte) (int, int, bool) {
	rf.mu.Lock()
	defer rf.mu.Unlock()
	if rf.role != NodeRoleLeader {
		return -1, -1, false
	}
	newLog := rf.Append(payload)
	rf.BroadcastAppend()
	return int(newLog.Index), int(newLog.Term), true
}
    </pre>
</blockquote>
<div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/log_repl001.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div>  

  <p>
    å¦‚ä¸Šå›¾ä¸­ï¼Œç»¿è‰²çš„è¡¨ç¤ºå®¢æˆ·ç«¯èŠ‚ç‚¹ï¼Œå®ƒå‘é€ SET 5 çš„è¯·æ±‚è¿‡æ¥ï¼ŒA ä½œä¸ºå½“å‰é›†ç¾¤ä¸­çš„ Leader èŠ‚ç‚¹é¦–å…ˆä¼šæŠŠè¿™ä¸ª SET 5 æ“ä½œå°è£…æˆä¸€ä¸ªæ—¥å¿—æ¡ç›®å†™å…¥åˆ°è‡ªå·±çš„æ—¥å¿—å­˜å‚¨ç»“æ„ä¸­ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡ç»™ä»èŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯çš„æ—¶å€™å¸¦ä¸Šè¿™ä¸ªæ—¥å¿—å‘é€ç»™ Follower èŠ‚ç‚¹ã€‚
  </p>

  <p>
    åœ¨ eraft å®ç°ä¸­ï¼Œæˆ‘ä»¬ä¸“é—¨æœ‰ä¸€ç»„ Goruntine åšæ—¥å¿—å¤åˆ¶ç›¸å…³çš„äº‹æƒ…ï¼Œç”¨æˆ·ææ¡ˆåˆ°è¾¾ Leader ä¹‹åè°ƒç”¨ BroadcastAppend ä¼šå”¤é†’åšæ—¥å¿—å¤åˆ¶æ“ä½œçš„ Goruntine, replicatorCond è¿™ä¸ªä¿¡å·é‡ç”¨æ¥å®Œæˆ Goruntine ä¹‹é—´çš„åŒæ­¥æ“ä½œã€‚
  </p>

  <blockquote>
    <pre>

func (rf *Raft) BroadcastAppend() {
	for _, peer := range rf.peers {
		if peer.id == uint64(rf.me_) {
			continue
		}
		rf.replicatorCond[peer.id].Signal()
	}
}
    </pre>
  </blockquote>

  <p>
    å¤åˆ¶æ“ä½œçš„ Goruntine æ‰§è¡Œçš„ä»»åŠ¡å‡½æ•°æ˜¯ Replicatorï¼Œå½“ BroadcastAppend ä¸­é€šè¿‡ Signal å‡½æ•°å”¤é†’ä¿¡å·é‡ï¼Œrf.replicatorCond[].Wait() å°±ä¼šåœæ­¢é˜»å¡ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œè°ƒç”¨ replicateOneRound è¿›è¡Œæ•°æ®å¤åˆ¶ã€‚
  </p>

  <blockquote>
    <pre>

//
// Replicator manager duplicate run
//
func (rf *Raft) Replicator(peer *RaftClientEnd) {
	rf.replicatorCond[peer.id].L.Lock()
	defer rf.replicatorCond[peer.id].L.Unlock()
	for !rf.IsKilled() {
		PrintDebugLog("peer id wait for replicating...")
		for !(rf.role == NodeRoleLeader && rf.matchIdx[peer.id] < int(rf.logs.GetLast().Index)) {
			rf.replicatorCond[peer.id].Wait()
		}
		rf.replicateOneRound(peer)
	}
}

    </pre>
  </blockquote>
  replicateOneRound å°±ä¼šæŠŠæ—¥å¿—æ‰“åŒ…åˆ°ä¸€ä¸ª AppendEntriesRequest ä¸­å‘é€åˆ° Follower èŠ‚ç‚¹äº†ã€‚

  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/log_repl002.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div> 

  Follower æ”¶åˆ°è¿½åŠ è¯·æ±‚åä¼šæŠŠæ—¥å¿—æ¡ç›®è¿½åŠ åˆ°è‡ªå·±çš„æ—¥å¿—å­˜å‚¨ç»“æ„ä¸­ï¼Œç„¶åç»™ Leader å‘é€æˆåŠŸè¿½åŠ çš„å“åº”ã€‚Leader ç»Ÿè®¡åˆ°é›†ç¾¤åŠæ•°èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰æ—¥å¿—è¿½åŠ æˆåŠŸä¹‹åï¼Œå®ƒä¼šæŠŠè¿™æ¡æ—¥å¿—çŠ¶æ€è®¾ç½®ä¸ºå·²ç»æäº¤ (committed)ï¼Œç„¶åå°†æ“ä½œç»“æœå‘é€ç»™å®¢æˆ·ç«¯, å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒA è®¾ç½® SET 5

  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/log_repl003.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div> 

  <p>
  ä¹‹åè¿™ä¸ªæ—¥å¿—æäº¤çš„ä¿¡æ¯ä¼šåœ¨ä¸‹ä¸€æ¬¡ç»™ Follower å‘é€çš„å¿ƒè·³åŒ…ä¸­å¸¦è¿‡å»ï¼ŒFollower æ”¶åˆ°æ—¥å¿—ä¹Ÿä¼šæ›´æ–°è‡ªå·±çš„æ—¥å¿—æäº¤çŠ¶æ€ã€‚
</p>

<p>
æ—¥å¿—æäº¤ä¹‹åï¼ŒApply åç¨‹ä¼šæ”¶åˆ°é€šçŸ¥ï¼Œå¼€å§‹å°†å·²ç»æäº¤çš„æ—¥å¿— apply åˆ°çŠ¶æ€æœºä¸­ï¼Œæ—¥å¿—çš„æˆåŠŸ Apply ä¹‹åç»™å®¢æˆ·ç«¯å‘é€æˆåŠŸå†™å…¥çš„å“åº”åŒ…ã€‚
</p>

<p>
å¯¹åº” eraft å®ç°ä¸­ï¼Œæ—¥å¿—æäº¤ä¹‹å Leader èŠ‚ç‚¹ä¼šè°ƒç”¨ advanceCommitIndexForLeader å‡½æ•°ã€‚å®ƒä¼šè®¡ç®—å½“å‰æ—¥å¿—æäº¤çš„ç´¢å¼•å·ï¼Œç„¶åå’Œä¹‹å‰å·²ç»æäº¤çš„ commitIdx è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœæ›´å¤§ï¼Œå°±ä¼šæ›´æ–° commitIdxï¼ŒåŒæ—¶è°ƒç”¨ rf.applyCond.Signal() å”¤é†’åš Apply æ“ä½œçš„ Goruntineã€‚Applier å‡½æ•°æ˜¯ Apply Goruntine è¿è¡Œçš„ä»»åŠ¡å‡½æ•°ï¼Œå®ƒä¼š Wait applyCond è¿™ä¸ªä¿¡å·é‡ï¼Œå¦‚æœè¢«å”¤é†’ï¼Œå®ƒä¼šæ‹·è´åˆèŠ‚ç‚¹ä¸­å·²ç»æäº¤çš„æ—¥å¿—ï¼Œæ‰“åŒ…æˆ ApplyMsg å‘é€åˆ° applyCh é€šé“é€šçŸ¥åº”ç”¨å±‚ï¼Œåº”ç”¨å±‚æ‹¿åˆ° apply æ¶ˆæ¯ä¹‹åä¼šæ›´æ–°çŠ¶æ€æœºå¹¶å›åŒ…ç»™å®¢æˆ·ç«¯ã€‚
</p>

<blockquote>
    <pre>

func (rf *Raft) advanceCommitIndexForLeader() {
	sort.Ints(rf.matchIdx)
	n := len(rf.matchIdx)
	newCommitIndex := rf.matchIdx[n-(n/2+1)]
	if newCommitIndex > int(rf.commitIdx) {
		if rf.MatchLog(rf.curTerm, int64(newCommitIndex)) {
			PrintDebugLog(fmt.Sprintf("peer %d advance commit index %d at term %d", rf.me_, rf.commitIdx, rf.curTerm))
			rf.commitIdx = int64(newCommitIndex)
			rf.applyCond.Signal()
		}
	}
}

//
// Applier() Write the commited message to the applyCh channel
// and update lastApplied
//
func (rf *Raft) Applier() {
	for !rf.IsKilled() {
		rf.mu.Lock()
		for rf.lastApplied >= rf.commitIdx {
			PrintDebugLog("applier ...")
			rf.applyCond.Wait()
		}
		firstIndex, commitIndex, lastApplied := rf.logs.GetFirst().Index, rf.commitIdx, rf.lastApplied
		entries := make([]*pb.Entry, commitIndex-lastApplied)
		copy(entries, rf.logs.GetRange(lastApplied+1-int64(firstIndex), commitIndex+1-int64(firstIndex)))
		rf.mu.Unlock()

		PrintDebugLog(fmt.Sprintf("%d, applies entries %d-%d in term %d", rf.me_, rf.lastApplied, commitIndex, rf.curTerm))

		for _, entry := range entries {
			rf.applyCh <- &pb.ApplyMsg{
				CommandValid: true,
				Command:      entry.Data,
				CommandTerm:  int64(entry.Term),
				CommandIndex: int64(entry.Index),
			}
		}

		rf.mu.Lock()
		rf.lastApplied = int64(Max(int(rf.lastApplied), int(commitIndex)))
		rf.mu.Unlock()
	}
}
    </pre>
</blockquote>


<h3>
    Raft å¿«ç…§å®ç°åˆ†æ

</h3>
ä¸‹é¢æ˜¯æ—¥å¿—å¿«ç…§çš„ RPC å®šä¹‰


<blockquote>
    <pre>
        message InstallSnapshotRequest {
            int64 term =                1;
            int64 leader_id =           2;
            int64 last_included_index = 3;
            int64 last_included_term  = 4;
            bytes data                = 5;
        }
        
        message InstallSnapshotResponse {
            int64 term = 1; 
        }
        
        rpc Snapshot (InstallSnapshotRequest) returns (InstallSnapshotResponse) {}
    </pre>
</blockquote>

    <p>InstallSnapshotRequest ä¸­ term ä»£è¡¨å½“å‰å‘é€å¿«ç…§çš„ Leader çš„ä»»æœŸï¼ŒFollower å°†å®ƒä¸è‡ªå·±çš„ä»»æœŸå·æ¥å†³å®šæ˜¯å¦è¦æ¥æ”¶è¿™ä¸ªå¿«ç…§ã€‚leader_id æ˜¯å½“å‰ leader çš„ id, è¿™æ ·å®¢æˆ·ç«¯è®¿é—®åˆ° Follower èŠ‚ç‚¹ä¹‹åä¹Ÿèƒ½å¿«é€ŸçŸ¥é“ Leader ä¿¡æ¯ã€‚last_included_index å’Œ last_included_term è¿˜æœ‰ data å¯ä»¥å‚è§æˆ‘ä»¬ç¬¬ä¸‰ç« å›¾ä¸­çš„ä»‹ç»ï¼Œå®ƒä»¬è®°å½•äº†æ‰“å®Œå¿«ç…§ä¹‹åç¬¬ä¸€æ¡æ—¥å¿—çš„ç´¢å¼•å·å’Œä»»æœŸå·ï¼Œä»¥åŠçŠ¶æ€æœºåºåˆ—åŒ–ä¹‹åçš„æ•°æ®ã€‚

    </p>

    
    <p>ä»€ä¹ˆæ—¶é—´ç‚¹ Raft ä¼šæ‰“å¿«ç…§å‘¢?

    </p>

    <p>
        æˆ‘ä»¬çŸ¥é“æ—¥å¿—æ¡ç›®è¿‡å¤šäº†ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰“å¿«ç…§ã€‚åœ¨ eraft ä¸­å°±æ˜¯è®¡ç®—å½“å‰ level ä¸­çš„æ—¥å¿—æ¡ç›® s.Rf.GetLogCount() æ¥æ‰“å¿«ç…§çš„ï¼Œæ‰“å¿«ç…§çš„å…¥å£å‡½æ•°æ˜¯ takeSnapshot(index int), ä¼ å…¥äº†å½“å‰ applied æ—¥å¿—çš„ id, ç„¶åå°†çŠ¶æ€æœºçš„æ•°æ®åºåˆ—åŒ–ï¼Œè°ƒç”¨ Raftå±‚çš„ Snapshot å‡½æ•°ã€‚ è¿™ä¸ªå‡½æ•°é€šè¿‡ EraseBeforeWithDel åšäº†åˆ é™¤æ—¥å¿—çš„æ“ä½œï¼Œç„¶å PersisSnapshot å°†å¿«ç…§ä¸­çŠ¶æ€æ•°æ®ç¼“å­˜åˆ°äº†å­˜å‚¨å¼•æ“ä¸­ã€‚
    </p>

    <blockquote>
        <pre>

//
// take a snapshot
//
func (rf *Raft) Snapshot(index int, snapshot []byte) {
	rf.mu.Lock()
	defer rf.mu.Unlock()
	rf.isSnapshoting = true
	snapshotIndex := rf.logs.GetFirstLogId()
	if index <= int(snapshotIndex) {
		rf.isSnapshoting = false
		PrintDebugLog("reject snapshot, current snapshotIndex is larger in cur term")
		return
	}
	rf.logs.EraseBeforeWithDel(int64(index) - int64(snapshotIndex))
	rf.logs.SetEntFirstData([]byte{}) // ç¬¬ä¸€ä¸ªæ“ä½œæ—¥å¿—å·è®¾ä¸ºç©º
	PrintDebugLog(fmt.Sprintf("del log entry before idx %d", index))
	rf.isSnapshoting = false
	rf.logs.PersisSnapshot(snapshot)
}
        </pre>
    </blockquote>

    <p>
        ä»€ä¹ˆæ—¶é—´ç‚¹ Leader ä¼šå‘é€å¿«ç…§å‘¢ï¼Ÿ


    </p>

    <p>
        åœ¨å¤åˆ¶çš„æ—¶å€™æˆ‘ä»¬ä¼šåˆ¤æ–­åˆ° peer çš„ prevLogIndex, å¦‚æœæ¯”å½“å‰æ—¥å¿—çš„ç¬¬ä¸€æ¡ç´¢å¼•å·è¿˜å°ï¼Œå°±è¯´æ˜ Leader å·²ç»æŠŠè¿™æ¡æ—¥å¿—æ‰“åˆ°å¿«ç…§ä¸­äº†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±è¦æ„é€  InstallSnapshotRequest è°ƒç”¨ Snapshot RPC å°†å¿«ç…§æ•°æ®å‘é€ç»™ Followr èŠ‚ç‚¹ï¼Œåœ¨æ”¶åˆ°æˆåŠŸå“åº”ä¹‹åï¼Œæˆ‘ä»¬ä¼šæ›´æ–° rf.matchIdxï¼Œrf.nextId ä¸º LastIncludedIndex å’Œ LastIncludedIndex + 1ï¼Œæ›´æ–°åˆ° Follower èŠ‚ç‚¹å¤åˆ¶è¿›åº¦ã€‚


    </p>

    <blockquote>
        <pre>

if prevLogIndex < uint64(rf.logs.GetFirst().Index) {
	firstLog := rf.logs.GetFirst()
	snapShotReq := &pb.InstallSnapshotRequest{
		Term:              rf.curTerm,
		LeaderId:          int64(rf.me_),
		LastIncludedIndex: firstLog.Index,
		LastIncludedTerm:  int64(firstLog.Term),
		Data:              rf.ReadSnapshot(),
	}

	rf.mu.RUnlock()

	PrintDebugLog(fmt.Sprintf("send snapshot to %s with %s\n", peer.addr, snapShotReq.String()))

	snapShotResp, err := (*peer.raftServiceCli).Snapshot(context.Background(), snapShotReq)
	if err != nil {
		PrintDebugLog(fmt.Sprintf("send snapshot to %s failed %v\n", peer.addr, err.Error()))
	}

	rf.mu.Lock()
	PrintDebugLog(fmt.Sprintf("send snapshot to %s with resp %s\n", peer.addr, snapShotResp.String()))

	if snapShotResp != nil {
		if rf.role == NodeRoleLeader && rf.curTerm == snapShotReq.Term {
			if snapShotResp.Term > rf.curTerm {
				rf.SwitchRaftNodeRole(NodeRoleFollower)
				rf.curTerm = snapShotResp.Term
				rf.votedFor = -1
				rf.PersistRaftState()
			} else {
				PrintDebugLog(fmt.Sprintf("set peer %d matchIdx %d\n", peer.id, snapShotReq.LastIncludedIndex))
				rf.matchIdx[peer.id] = int(snapShotReq.LastIncludedIndex)
				rf.nextIdx[peer.id] = int(snapShotReq.LastIncludedIndex) + 1
			}
		}
	}
	rf.mu.Unlock()
}
        </pre>
    </blockquote>

    <p>
        Follower è¿™è¾¹æ“ä½œå°±æ¯”è¾ƒç®€å•äº†ï¼Œå®ƒä¼šè°ƒç”¨ HandleInstallSnapshot å¤„ç†å¿«ç…§æ•°æ®ï¼Œå¹¶æŠŠå¿«ç…§æ•°æ®æ„é€  pb.ApplyMsg å†™åˆ° rf.applyChï¼Œæœ€åè´Ÿè´£æ—¥å¿— Apply çš„ Goruntine ä¼šè°ƒç”¨ CondInstallSnapshot å®‰è£…å¿«ç…§ï¼Œæœ€ååœ¨ restoreSnapshot ä¼šå°†å¿«ç…§çš„ data æ•°æ®è§£æï¼Œè®©åå†™å…¥è‡ªå·±çš„çŠ¶æ€æœºã€‚
    </p>

    <h3>
        Raft å¦‚ä½•åº”å¯¹è„‘è£‚
    </h3>

    <p>åœ¨ç¬¬ä¸‰ç« ä¸­æˆ‘ä»¬ï¼Œä»‹ç»äº†è„‘è£‚çš„åœºæ™¯ï¼Œå¹¶ä¸”åˆ†è¿‡å¤šæ•°æ´¾é€‰ä¸¾åè®®å¯ä»¥é¿å…è„‘è£‚çš„åœºæ™¯ï¼Œä½¿å¾—åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹ä¹Ÿèƒ½ä¿æŒæ­£ç¡®æ€§ã€‚

    </p>

    <p>
        Raft æ˜¯ä¸€ç§å¤šæ•°æ´¾é€‰ä¸¾çš„åè®®ï¼Œç°åœ¨æˆ‘ä»¬å°±æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åº”å¯¹è„‘è£‚çš„ã€‚
    </p>


  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/split_net001.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div> 

  æˆ‘ä»¬çœ‹åˆ°ä¸Šå›¾ä¸­çš„åœºæ™¯ï¼Œä¸€ä¸ªäº”èŠ‚ç‚¹çš„ç³»ç»Ÿè¢«åˆ†æˆäº†ä¸¤ä¸ªåŒºï¼ŒC,D,E ä¸ºä¸€ä¸ªåŒºï¼ŒA,B ä¸ºä¸€ä¸ªåŒºã€‚è¿™æ—¶å€™ä¸¤ä¸ªåˆ†åŒºä¸­éƒ½é€‰å‡ºäº†å„è‡ªçš„ Leaderï¼Œä½†æ˜¯æ³¨æ„ B æ˜¯ä»»æœŸ 1 çš„ Leaderï¼ŒC æ˜¯ä»»æœŸ 2 Leaderã€‚å¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘é—®ä¸ºä»€ä¹ˆä¸€å®šæœ‰ä¸€ä¸ªä»»æœŸæ›´é«˜çš„ Leaderï¼Œè¿™å…¶å®ä¹Ÿæ˜¯å¤šæ•°æ´¾é€‰ä¸¾å†³å®šçš„ï¼Œåˆ†åŒºåï¼Œè‚¯å®šä¼šå‡ºç°ä¸€ä¸ªå¤šæ•°èŠ‚ç‚¹æ‰€åœ¨çš„åˆ†åŒºï¼Œå¦‚æœè¿™ä¸ªåˆ†åŒºè¿˜æ²¡æœ‰ Leader, é‚£ä¹ˆè‚¯å®šä¼šè§¦å‘é€‰ä¸¾ã€‚

  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/split_net002.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div> 

  ä¹‹åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒC,D,E æ‰€åœ¨åˆ†åŒºè¢«å†™å…¥äº† SET 8 çš„æ“ä½œï¼Œç”±äº C,D,E æœ‰ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œè¶…è¿‡ 5 ä¸ªèŠ‚ç‚¹çš„åŠæ•°ä»¥ä¸Šï¼Œæ‰€ä»¥ SET 8 è¿™ä¸ªæ“ä½œè¢«æäº¤äº†ã€‚ç„¶å A,B åˆ†åŒºè¢«å†™å…¥ SET 3 æ“ä½œï¼Œä½†æ˜¯ç”±äºå®ƒä»¬æ˜¯å°‘æ•°æ´¾ï¼Œåªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥ SET 3 è¿™ä¸ªæ“ä½œå†™å…¥å®ƒä»¬çš„æ—¥å¿—ä¹‹åå¹¶ä¸èƒ½è¢«æäº¤ã€‚

  <div style="text-align: center; width: 100%; border: black solid 1px;">
    <img src="./resources/split_net003.png" width="90%" style="display: inline-block; margin-bottom: 5%;"/>
  </div> 

  æœ€åç½‘ç»œæ¢å¤äº†ï¼ŒB,A æ”¶åˆ°æ¥è‡ª C çš„æ›´é«˜ä»»æœŸçš„å¿ƒè·³ä¼šç§’å˜ Follower å¹¶ä¸”ä¼šå°†ä¹‹å‰æ²¡æœ‰æäº¤çš„æ—¥å¿—æ“¦é™¤ï¼Œå°† Leader C å‘è¿‡æ¥çš„æ–°æ—¥å¿—ï¼ˆå¸¦æœ‰ SET 8 æ“ä½œï¼‰å†™åˆ°è‡ªå·±çš„æ—¥å¿—ä¸­ï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿä»ç„¶æ˜¯ä¸€è‡´çš„ã€‚


      <h3>æèµ 
      </h3>

      <p>
        æ•´ç†è¿™æœ¬ä¹¦è€—è´¹äº†æˆ‘ä»¬å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ã€‚å¦‚æœä½ è§‰å¾—æœ‰å¸®åŠ©ï¼Œä¸€ç“¶çŸ¿æ³‰æ°´çš„ä»·æ ¼æ”¯æŒæˆ‘ä»¬ç»§ç»­è¾“å‡ºä¼˜è´¨çš„åˆ†å¸ƒå¼å­˜å‚¨çŸ¥è¯†ä½“ç³»ï¼Œ2.99Â¥ï¼Œæ„Ÿè°¢å¤§å®¶çš„æ”¯æŒã€‚
      </p>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/alipay.jpeg" width="200px" style="display: inline-block;"/>
      </div>

      <p> éµå¾ªMITåè®®å¼€æºã€‚</p>
      <p> æ„Ÿè°¢ ã€Œèµ«è¹ã€ æä¾›å¦‚æ­¤ä¼˜ç§€çš„ä¸­æ–‡æ’ç‰ˆç³»ç»Ÿ </p>


      <!-- <footer class="heti-fn">
        <ol>
          <li id="fn-01">
            <a href="#ref-01" title="ç§»è‡³">^</a>
            CSS Resetï¼šæŒ‡ä»£ç±»ä¼¼Eric Meyer's Reset CSSçš„æ ·å¼é‡ç½®æ–¹æ¡ˆ
          </li>
          <li id="fn-02">
            <a href="#ref-02" title="ç§»è‡³">^</a>
            ã€Šä¸­æ–‡æ’ç‰ˆéœ€æ±‚ã€‹ï¼šhttps://w3c.github.io/clreq/
          </li>
          <li id="fn-03">
            <a href="#ref-03" title="ç§»è‡³">^</a>
            åœ¨å½“ä¸‹å‰ç«¯æŠ€æœ¯å°šä¸èƒ½å®Œç¾è§£å†³ä¸­è¥¿æ–‡æ··æ’é—´è·çš„æƒ…å†µä¸‹ï¼Œå¸¸è§çš„è¾“å…¥ä¹ æƒ¯æ˜¯æ‰‹åŠ¨åœ¨ä¸­è¥¿æ–‡é—´åŠ å…¥ç©ºæ ¼ï¼ˆhttps://github.com/vinta/pangu.jsï¼‰ã€‚è¿™æ ·åšçš„å¼Šç«¯ä¸€æ˜¯é—´è·ä¸å¯æ§ï¼ˆæœ‰æ—¶æ˜¾å¾—è¿‡å¤§ï¼‰ï¼ŒäºŒæ˜¯é€šè¿‡ç©ºæ ¼ç¬¦æ¥æ’ç‰ˆåªèƒ½ç®—æ— å¥ˆä¹‹ä¸¾ã€‚å¥½æ¶ˆæ¯æ˜¯åœ¨æœ€æ–°çš„macOSã€iOSä¸­ï¼Œä½¿ç”¨åŸç”Ÿè¯­è¨€å¼€å‘çš„æ–‡æœ¬åŒºåŸŸä¼šè‡ªåŠ¨å¤„ç†ä¸­è¥¿æ–‡æ··æ’çš„é—´è·ï¼ˆæ— è®ºæ˜¯å¦åŠ ç©ºæ ¼ï¼‰ï¼ŒæœŸå¾…ä¸ç”¨æ‰‹æ•²ç©ºæ ¼çš„æ—¥å­æ—©æ—¥åˆ°æ¥ã€‚
          </li>
        </ol>
      </footer> -->
      <script src="https://giscus.app/client.js"
      data-repo="eraft-io/eraft-io.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnkzOTYyMDM3NjU="
      data-category="General"
      data-category-id="DIC_kwDOF52W9c4CRblA"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="zh-CN"
      crossorigin="anonymous"
      async>
  </script>

    </article>

    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡</span>

  </main>




  <aside class="panel">
    <ul class="panel-list panel-list--gray">
      <li><input type="radio" class="J_fontStack" value="heti--classic" name="font" id="font-classic" checked><label for="font-classic">ä¼ ç»Ÿ</label></li>
      <li><input type="radio" class="J_fontStack" value="heti--sans" name="font" id="font-sans"><label for="font-sans">é»‘ä½“</label></li>
      <li><input type="radio" class="J_fontStack" value="heti--serif" name="font" id="font-serif"><label for="font-serif">å®‹ä½“</label></li>
    </ul>
    <ul class="panel-list panel-list--gray">
      <li><input type="radio" class="J_radioGrid" value="" name="grid" id="grid-disable" checked><label for="grid-disable">ç½‘æ ¼ï¼šå…³</label></li>
      <li><input type="radio" class="J_radioGrid" value="grid-24" name="grid" id="grid-24"><label for="grid-24">å¤§</label></li>
      <li><input type="radio" class="J_radioGrid" value="grid-12" name="grid" id="grid-12"><label for="grid-12">å°</label></li>
    </ul>
    <ul class="panel-list panel-list--gray panel-list--icon">
      <li><input type="radio" class="J_darkMode" value="auto" name="darkmode" id="darkmode-auto" checked><label for="darkmode-auto">ğŸŒ—</label></li>
      <li><input type="radio" class="J_darkMode" value="light" name="darkmode" id="darkmode-light"><label for="darkmode-light">ğŸŒ</label></li>
      <li><input type="radio" class="J_darkMode" value="dark" name="darkmode" id="darkmode-dark"><label for="darkmode-dark">ğŸŒ™</label></li>
    </ul>
  </aside>

  <script src="./heti-addon.js"></script>
  <script>
    const $$root = document.getElementsByTagName('html')[0]
    const $$main = document.getElementsByTagName('main')[0]
    const $$article = document.getElementsByTagName('article')[0]

    function addEventListeners(nodeList, event, fn) {
      [].forEach.call(nodeList, function(elm) {
        elm.addEventListener(event, fn, false)
      }, false)
    }

    addEventListeners(document.getElementsByClassName('J_darkMode'), 'change', function (e) {
      $$root.setAttribute('data-darkmode', e.target.value)
    })

    addEventListeners(document.getElementsByClassName('J_radioGrid'), 'change', function (e) {
      $$main.setAttribute('data-bg-grid', e.target.value)
    })

    addEventListeners(document.getElementsByClassName('J_fontStack'), 'change', function (e) {
      $$article.className = ['article', 'heti', e.target.value].join(' ')
    })

    const heti = new Heti('.article')
    heti.autoSpacing()
  </script>
</body>
</html>
