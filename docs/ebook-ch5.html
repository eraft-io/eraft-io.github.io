<!DOCTYPE html>
<html lang="zh-Hans" data-darkmode="auto">
<head>
  <meta charset="UTF-8">
  <title>eraftå¼€å‘ç»„ - è§£è¯»å›½å¤–ä¼˜è´¨è®¡ç®—æœºè¯¾ç¨‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./heti.css">
  <link rel="stylesheet" href="./index.css">
  <link rel="icon" href="./favicon.svg">
</head>
<body>
  <main class="container">
    <article class="article heti heti--classic">
        <h1 class="article__title">eraft ç²¾è§£è¯¾ç¨‹</h1>
        <blockquote>

        æˆ‘ä»¬å›¢é˜Ÿè‡´åŠ›äºè§£è¯»å›½å¤–ä¼˜ç§€çš„åˆ†å¸ƒå¼å­˜å‚¨ç›¸å…³å¼€æºè¯¾ç¨‹ï¼Œä¸‹é¢æ˜¯è¯¾ç¨‹ä½“ç³»å›¾
        æˆ‘ä»¬å§‹ç»ˆåšä¿¡ä¼˜ç§€çš„æœ¬ç§‘æ•™å­¦ä¸åº”è¯¥æ˜¯ç…§æœ¬å®£ç§‘ä»¥åŠåº”ä»˜è€ƒè¯•ï¼Œä¸€é—¨ä¼˜ç§€çš„è¯¾ç¨‹ï¼Œåº”è¯¥å…·å¤‡è®©å­¦ç”Ÿå­¦ä¼šæ€è€ƒã€åŠ¨æ‰‹å®è·µã€æ‰¾åˆ°é—®é¢˜ã€åå¤è¯•é”™ã€å¹¶è§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼ŒåŒæ—¶åº”è¯¥å°½é‡ç”¨æœ€ç›´ç™½ï¼Œæœ€ç®€å•çš„è¯­è¨€ä¼ è¾¾å…³é”®çš„çŸ¥è¯†ç‚¹ã€‚ä½œä¸ºè®¡ç®—æœºå·¥ä¸šç•Œçš„å·¥ä½œè€…ï¼Œæˆ‘ç›¸ä¿¡åšè¯¾ç¨‹å’ŒåšæŠ€æœ¯ä¸€æ ·ï¼Œå¹¶ä¸æ˜¯è¶Šå¤æ‚è¶Šå¥½ï¼Œåº”è¯¥å°½é‡çš„è®©è®¾è®¡å‡ºæ¥çš„ä¸œè¥¿ç®€å•åŒ–ã€‚
        å…³æ³¨æˆ‘ä»¬çš„æœ€æ–°åŠ¨æ€ï¼Œæ¬¢è¿å…³æ³¨
         
        <a href="https://www.zhihu.com/people/liu-jie-84-52" target="_blank">https://www.zhihu.com/people/liu-jie-84-52</a>
        æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿã€‚

      </blockquote>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/arch.png" width="40%" style="display: inline-block; margin-bottom: 5%;"/>
      </div>

        <details open>
          <summary></summary>
          <ol>
            <li>
              <a href="#intro">MIT6.824 åˆ†å¸ƒå¼ç³»ç»Ÿç³»åˆ—</a>
              <ul>
                <li><a href="./index.html">ï¼ˆä¸€ï¼‰ä½“éªŒåˆ†å¸ƒå¼KVå­˜å‚¨ç³»ç»Ÿeraftkv </a></li>
                <li><a href="./ebook-ch2.html">ï¼ˆäºŒï¼‰Go è¯­è¨€åŸºç¡€çŸ¥è¯†</a></li>
                <li><a href="./ebook-ch3.html">ï¼ˆä¸‰ï¼‰Raft è®ºæ–‡è§£è¯» </a></li>
                <li><a href="./ebook-ch4.html">ï¼ˆå››ï¼‰æ„å»º Raft åº“                </a></li>
                <li><a href="./ebook-ch5.html">ï¼ˆäº”ï¼‰åŸºäº Raft åº“ï¼Œå®ç°ç®€å•çš„åˆ†å¸ƒå¼ KV ç³»   </a></li>
                <li><a href="./ebook-ch6.html">ï¼ˆå…­ï¼‰Multi-Raft è®¾è®¡ä¸å®ç°   </a></li>
                <li><a href="./ebook-ch7.html">ï¼ˆä¸ƒï¼‰åˆ†å¸ƒå¼äº‹åŠ¡åˆæ¢   </a></li>
              </ul>
            </li>
          </ol>
        </details>

      <h2 id="intro"> MIT åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆäº”ï¼‰åŸºäº Raft åº“ï¼Œå®ç°ç®€å•çš„åˆ†å¸ƒå¼ KV ç³»ç»Ÿ <a class="anchor" href="#intro">#</a></h2>

      <h3>
        ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ
      </h3>

      <p>
        ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»äº†æˆ‘ä»¬æ„å»ºå¥½çš„ Raft åº“ï¼Œå®ƒåœ¨ eraft/raftcore ç›®å½•ä¸‹ã€‚ç°åœ¨æˆ‘ä»¬è¦ä½¿ç”¨è¿™ä¸ªåº“æ¥æ„å»ºä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼ KV å­˜å‚¨ç³»ç»Ÿã€‚
      </p>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/raft_overview.png" width="80%" style="display: inline-block; margin-bottom: 5%;"/>
      </div>

     <p>
        è®©æˆ‘ä»¬å›åˆ°ä¸Šå›¾ï¼Œè¿™ä¸ªå›¾åœ¨æˆ‘ä»¬ä¸€å¼€å§‹ä»‹ç» Raft çš„æ—¶å€™è®²åˆ°è¿‡ï¼Œæˆ‘ä»¬è¿™ä¸€ç« å°±è¦å®ç°è¿™æ ·ä¸€ä¸ªç³»ç»Ÿã€‚
     </p>

     <h3>
        å¯¹å¤–æ¥å£å®šä¹‰
     </h3>

     <p>
        ç¬¬ä¸€æ­¥æˆ‘ä»¬æ¥å®šä¹‰ç³»ç»Ÿä¸å®¢æˆ·ç«¯çš„äº¤äº’æ¥å£ï¼Œå®¢æˆ·ç«¯å¯ä»¥å‘é€ Put å’Œ Get æ“ä½œå°† KV æ•°æ®å†™åˆ°ç³»ç»Ÿä¸­ã€‚æˆ‘ä»¬éœ€è¦å®šä¹‰è¿™ä¸¤ä¸ªæ“ä½œçš„ RPCã€‚æˆ‘ä»¬å°†å®ƒä»¬åˆå¹¶åˆ°ä¸€ä¸ª RPC è¯·æ±‚é‡Œé¢ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š
     </p>

     <blockquote>
        <pre>
        // <br/>
// client op type <br/>
//<br/>
enum OpType {<br/>
    OpPut = 0;<br/>
    OpAppend = 1;<br/>
    OpGet = 2;<br/>
}<br/>
<br/>
//<br/>
// client command request<br/>
//<br/>
message CommandRequest {<br/>
    string key = 1;<br/>
    string value = 2;<br/>
    OpType op_type = 3;<br/>
    int64  client_id = 4;<br/>
    int64  command_id = 5;<br/>
    bytes  context = 6;<br/>
}<br/>
<br/>
//<br/>
// client command response<br/>
//<br/>
message CommandResponse {<br/>
    string value = 1;<br/>
    int64  leader_id = 2;<br/>
    int64  err_code = 3;<br/>
}<br/>

rpc DoCommand (CommandRequest) returns (CommandResponse) {}<br/>
</pre>
     </blockquote>

     <p>
        å…¶ä¸­ OpType å®šä¹‰äº†æˆ‘ä»¬æ”¯æŒçš„æ“ä½œç±»å‹ï¼šput,Append,getã€‚ å®¢æˆ·ç«¯è¯·æ±‚çš„å†…å®¹å®šä¹‰åœ¨äº† CommandRequest ä¸­ã€‚CommandRequest ä¸­æœ‰æˆ‘ä»¬çš„ key, value ä»¥åŠæ“ä½œç±»å‹ï¼Œè¿˜æœ‰å®¢æˆ·ç«¯ id ä»¥åŠå‘½ä»¤ id, è¿˜æœ‰ä¸€ä¸ªå­—èŠ‚ç±»å‹çš„ context ï¼ˆcontext å¯ä»¥å­˜æ”¾ä¸€äº›æˆ‘ä»¬éœ€è¦é™„åŠ çš„ä¸ç¡®å®šçš„å†…å®¹ï¼‰ã€‚
     </p>

     <p>
        å“åº” CommandResponse åŒ…æ‹¬äº†è¿”å›å€¼ value ï¼Œleader_id å­—æ®µï¼ˆå‘Šè¯‰æˆ‘ä»¬å½“å‰ Leader æ˜¯å“ªä¸ªèŠ‚ç‚¹çš„ã€‚å› ä¸ºæœ€å¼€å§‹å®¢æˆ·ç«¯å‘é€è¯·æ±‚æ—¶ï¼Œä¸çŸ¥é“é‚£ä¸ªèŠ‚ç‚¹è¢«é€‰æˆ Leader ã€‚æˆ‘ä»¬é€šè¿‡ä¸€æ¬¡è¯•æ¢è¯·æ±‚æ‹¿åˆ° Leader èŠ‚ç‚¹çš„ id, ç„¶åå†æ¬¡å‘é€è¯·æ±‚ç»™ Leader èŠ‚ç‚¹ã€‚ï¼‰ï¼Œä»¥åŠé”™è¯¯ç  err_codeï¼ˆè®°å½•å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼‰ã€‚
     </p>

     <p>
        å®¢æˆ·ç«¯é€šè¿‡ DoCommand RPC è¯·æ±‚åˆ°æˆ‘ä»¬çš„åˆ†å¸ƒå¼ KV ç³»ç»Ÿã€‚é‚£æˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯æ€ä¹ˆå¤„ç†è¯·æ±‚çš„å‘¢ï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æœåŠ¡ç«¯çš„ç»“æ„çš„å®šä¹‰ã€‚ mu æ˜¯ä¸€æŠŠè¯»å†™é”ï¼Œç”¨æ¥å¯¹å¯èƒ½å‡ºç°å¹¶å‘å†²çªçš„æ“ä½œåŠ é”ã€‚dead è¡¨ç¤ºå½“å‰æœåŠ¡èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæ˜¯ä¸æ˜¯å­˜æ´»ã€‚Rf æ¯”è¾ƒé‡è¦ï¼Œè¿™ä¸ªæ˜¯åªæƒ³æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„ Raft ç»“æ„çš„æŒ‡é’ˆã€‚applyCh æ˜¯ä¸€ä¸ªé€šé“ï¼Œç”¨æ¥ä»æˆ‘ä»¬çš„ç®—æ³•åº“ä¸­è¿”å›å·²ç» apply çš„æ—¥å¿—ã€‚æˆ‘ä»¬çš„ server æ‹¿åˆ°è¿™ä¸ªæ—¥ä¹‹åéœ€è¦ apply åˆ°å®é™…çš„çŠ¶æ€æœºä¸­ã€‚stm å°±æ˜¯æˆ‘ä»¬çš„çŠ¶æ€æœºäº†ï¼Œæˆ‘ä»¬ä¸€ä¼šå„¿ä»‹ç»ã€‚notifyChans æ˜¯ä¸€ä¸ªå­˜å‚¨å®¢æˆ·ç«¯å“åº”çš„ mapï¼Œå…¶ä¸­å€¼æ˜¯ä¸€ä¸ªé€šé“ã€‚KvServer åœ¨åº”ç”¨æ—¥å¿—åˆ°çŠ¶æ€æœºæ“ä½œå®Œä¹‹åï¼Œä¼šç»™å®¢æˆ·ç«¯å‘é€å“åº”åˆ°è¿™ä¸ªé€šé“ä¸­ã€‚stopApplyCh ç”¨æ¥åœæ­¢æˆ‘ä»¬çš„ Apply æ“ä½œã€‚ 
     </p>

     <h3>
        æœåŠ¡ç«¯æ ¸å¿ƒå®ç°åˆ†æ
     </h3>

     <blockquote>
        <pre>
        type KvServer struct {<br/>
            <br/>
            mu      sync.RWMutex<br/>
            dead    int32<br/>
            Rf      *raftcore.Raft<br/>
            applyCh chan *pb.ApplyMsg<br/>
        
            lastApplied int<br/>
        
            stm         StateMachine<br/>
            notifyChans map[int]chan *pb.CommandResponse<br/>
            stopApplyCh chan interface{}<br/>
            <br/>
            pb.UnimplementedRaftServiceServer<br/>
        }<br/>
    </pre>
     </blockquote>

     <p>æœ‰äº†è¿™ä¸ªç»“æ„ä¹‹åï¼Œæˆ‘ä»¬è¦å¦‚ä½•åº”ç”¨ Raft ç®—æ³•åº“å®ç°å›¾ä¸­é«˜å¯ç”¨çš„ kv åˆ†å¸ƒå¼ç³»ç»Ÿå‘¢ï¼Ÿ
    </p>

    <p>

        1.é¦–å…ˆæˆ‘ä»¬è¦æ„é€ åˆ°æ¯ä¸ª server çš„ rpc å®¢æˆ·ç«¯ï¼›
        <br/>
2.ç„¶åï¼Œæ„é€  applyCh é€šé“ï¼Œä»¥åŠæ„é€ æ—¥å¿—å­˜å‚¨ç»“æ„ï¼›
<br/>
3.ä¹‹åï¼Œè°ƒç”¨ MakeRaft æ„é€ æˆ‘ä»¬çš„ Raft ç®—æ³•åº“æ ¸å¿ƒç»“æ„ï¼›
<br/>
4.æœ€åï¼Œå¯åŠ¨ Apply Goruntineï¼Œä»é€šé“ä¸­ç›‘å¬åœ¨ç»è¿‡ Raft ç®—æ³•åº“ä¹‹åè¿”å›çš„æ¶ˆæ¯ã€‚
<br/>
    </p>

    <blockquote>
        <pre>
        func MakeKvServer(nodeId int) *KvServer {<br/>
            clientEnds := []*raftcore.RaftClientEnd{}<br/>
            for id, addr := range PeersMap {<br/>
                newEnd := raftcore.MakeRaftClientEnd(addr, uint64(id))<br/>
                clientEnds = append(clientEnds, newEnd)<br/>
            }<br/>
            newApplyCh := make(chan *pb.ApplyMsg)<br/>
            <br/>
            logDbEng, err := storage_eng.MakeLevelDBKvStore("./data/kv_server" + "/node_" + strconv.Itoa(nodeId))<br/>
            if err != nil {<br/>
                raftcore.PrintDebugLog("boot storage engine err!")<br/>
                panic(err)<br/>
            }<br/>
            <br/>
            // æ„é€  Raft ç»“æ„ï¼Œä¼ å…¥ clientEndsï¼Œå½“å‰èŠ‚ç‚¹ id, æ—¥å¿—å­˜å‚¨çš„ db, apply é€šé“ï¼Œå¿ƒè·³è¶…æ—¶æ—¶é—´ï¼Œå’Œé€‰ä¸¾è¶…æ—¶æ—¶é—´<br/>
            // ç”±äºæ˜¯æµ‹è¯•ï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿé€‰ä¸¾çš„æ—¥å¿—ï¼Œæˆ‘ä»¬è®¾ç½®çš„æ—¶é—´æ˜¯ 1s å’Œ 3s, ä½ å¯ä»¥è®¾ç½®çš„æ›´çŸ­<br/>
            newRf := raftcore.MakeRaft(clientEnds, nodeId, logDbEng, newApplyCh, 1000, 3000)<br/>
            kvSvr := &KvServer{Rf: newRf, applyCh: newApplyCh, dead: 0, lastApplied: 0, stm: NewMemKV(), notifyChans: make(map[int]chan *pb.CommandResponse)}<br/>
            kvSvr.stopApplyCh = make(chan interface{})<br/>
            <br/>
            // å¯åŠ¨ apply Goruntine
            go kvSvr.ApplingToStm(kvSvr.stopApplyCh)<br/>
            <br/>
            return kvSvr
            <br/>
        }
        <br/>
    </pre>
    </blockquote>

    <p>
        å®¢æˆ·ç«¯å‘½ä»¤åˆ°æ¥ä¹‹åï¼Œæœ€å¼€å§‹è°ƒç”¨çš„æ˜¯ DoCommand å‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°åšäº†å“ªäº›å·¥ä½œï¼š
    </p>

    <p>
        é¦–å…ˆï¼ŒDocommand å‡½æ•°è°ƒç”¨ Marshal åºåˆ—åŒ–äº†æˆ‘ä»¬çš„ CommandResponse åˆ° reqBytes çš„å­—èŠ‚æ•°ç»„ä¸­ï¼Œç„¶åè°ƒç”¨ Raft åº“çš„ Propose æ¥å£ï¼ŒæŠŠææ¡ˆæäº¤åˆ°æˆ‘ä»¬çš„ç®—æ³•åº“ä¸­ã€‚Raft ç®—æ³•ä¸­åªæœ‰ Leader å¯ä»¥å¤„ç†ææ¡ˆã€‚å¦‚æœèŠ‚ç‚¹ä¸æ˜¯ Leader æˆ‘ä»¬ä¼šç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ ErrCodeWrongLeader çš„é”™è¯¯ç ã€‚ä¹‹åå°±æ˜¯ä» getNotifyChan æ‹¿åˆ°å½“å‰æ—¥å¿— id å¯¹åº”çš„ apply é€šçŸ¥é€šé“ã€‚åªæœ‰è¿™æ¡æ—¥å¿—é€šçŸ¥åˆ°äº†ï¼Œä¸‹é¢ select æ‰ä¼šç»§ç»­å¾€ä¸‹èµ°ï¼Œæ‹¿åˆ°å€¼æ”¾åˆ° cmdResp.Value ä¸­ï¼Œå½“ç„¶å¦‚æœæ“ä½œè¶…è¿‡äº† ErrCodeExecTimeout æ—¶é—´ä¹Ÿä¼šç”Ÿæˆé”™è¯¯ç ï¼Œå“åº”å®¢æˆ·ç«¯æ‰§è¡Œè¶…è¶…æ—¶ã€‚
    </p>

    <blockquote>
        <pre>
        func (s *KvServer) DoCommand(ctx context.Context, req *pb.CommandRequest) (*pb.CommandResponse, error) {<br/>
            raftcore.PrintDebugLog(fmt.Sprintf("do cmd %s", req.String()))<br/>
            <br/>
            cmdResp := &pb.CommandResponse{}<br/>
            <br/>
            if req != nil {<br/>
                reqBytes, err := json.Marshal(req)<br/>
                if err != nil {<br/>
                    return nil, err<br/>
                }<br/>
                idx, _, isLeader := s.Rf.Propose(reqBytes)<br/>
                if !isLeader {<br/>
                    cmdResp.ErrCode = common.ErrCodeWrongLeader<br/>
                    return cmdResp, nil<br/>
                }<br/><br/>
        
                s.mu.Lock()<br/>
                ch := s.getNotifyChan(idx)<br/>
                s.mu.Unlock()<br/>
                <br/>
                select {<br/>
                case res := <-ch:<br/>
                    cmdResp.Value = res.Value<br/>
                case <-time.After(ExecCmdTimeout):<br/>
                    cmdResp.ErrCode = common.ErrCodeExecTimeout<br/>
                    cmdResp.Value = "exec cmd timeout"<br/>
                }<br/>
                <br/>
                go func() {<br/>
                    s.mu.Lock()<br/>
                    delete(s.notifyChans, idx)<br/>
                    s.mu.Unlock()<br/>
                }()<br/>
                <br/>
            }
            <br/>
            return cmdResp, nil<br/>
        }<br/>
    </pre>
    </blockquote>

    <p>
        æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹ Apply Goruntine å¹²çš„äº‹æƒ…ï¼š
    </p>

    <p>
        å®ƒç­‰å¾… s.applyCh é€šé“ä¸­ apply æ¶ˆæ¯çš„åˆ°æ¥ã€‚è¿™ä¸ª applyCh æˆ‘ä»¬åœ¨ Raft åº“ä¸­æåˆ°è¿‡ï¼Œå®ƒç”¨æ¥é€šçŸ¥åº”ç”¨å±‚æ—¥å¿—å·²ç»æäº¤ï¼Œåº”ç”¨å±‚å¯ä»¥æŠŠæ—¥å¿—åº”ç”¨åˆ°çŠ¶æ€æœºäº†ã€‚å½“ applyCh ä¸­ appliedMsg åˆ°æ¥ä¹‹åï¼Œæˆ‘ä»¬æ›´æ–°äº† KvServer çš„ lastApplied å·ï¼Œç„¶åæ ¹æ®å®¢æˆ·ç«¯çš„æ“ä½œç±»å‹å¯¹æˆ‘ä»¬çš„çŠ¶æ€æœºåšä¸åŒçš„æ“ä½œï¼Œåšå®Œä¹‹åæŠŠå“åº”æ”¾åˆ° notifyChan ä¸­ï¼Œä¹Ÿå°±æ˜¯ DoCommand ç­‰å¾…çš„é‚£ä¸ªé€šé“ï¼Œè‡³æ­¤æ•´ä¸ªè¯·æ±‚å¤„ç†çš„æµç¨‹å·²ç»ç»“æŸã€‚
    </p>

    <blockquote>
        <br/>
        <pre>
        func (s *KvServer) ApplingToStm(done <-chan interface{}) {<br/>
            for !s.IsKilled() {<br/>
                select {<br/>
                case <-done:<br/>
                    return<br/>
                case appliedMsg := <-s.applyCh:<br/>
                    req := &pb.CommandRequest{}<br/>
                    if err := json.Unmarshal(appliedMsg.Command, req); err != nil {<br/>
                        raftcore.PrintDebugLog("Unmarshal CommandRequest err")<br/>
                        continue<br/>
                    }<br/>
                    s.lastApplied = int(appliedMsg.CommandIndex)<br/>
                    <br/>
                    var value string<br/>
                    switch req.OpType {<br/>
                    case pb.OpType_OpPut:<br/>
                        s.stm.Put(req.Key, req.Value)<br/>
                    case pb.OpType_OpAppend:<br/>
                        s.stm.Append(req.Key, req.Value)<br/>
                    case pb.OpType_OpGet:<br/>
                        value, _ = s.stm.Get(req.Key)<br/>
                    }<br/>
                    <br/>
                    cmdResp := &pb.CommandResponse{}<br/>
                    cmdResp.Value = value<br/>
                    ch := s.getNotifyChan(int(appliedMsg.CommandIndex))<br/>
                    ch <- cmdResp<br/>
                }<br/>
            }<br/>
        }<br/>
    </pre>
    </blockquote>

    <h3>
        å®¢æˆ·ç«¯å®ç°ä»‹ç»
    </h3>

    <p>
        å®¢æˆ·ç«¯å®ç°å°±æ¯”è¾ƒç®€å•äº†ï¼Œä¸»è¦æ˜¯æ„é€  Get å’Œ Put çš„ CommandRequest è°ƒç”¨ DoCommand å‘é€åˆ°æœåŠ¡ç«¯ï¼Œé€»è¾‘å®ç°åœ¨ cmd/kvcli/kvcli.go é‡Œé¢ã€‚
    </p>

    <p>
        æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ï¼š
    </p>

    <p>
        å®¢æˆ·ç«¯è¯·æ±‚åˆ°æ¥ä¹‹åï¼Œ KvServer é¦–å…ˆä¼šè°ƒç”¨ Propose æäº¤æ—¥å¿—åˆ° Raft ä¸­ç®—æ³•åº“ã€‚Raft ç®—æ³•åº“ç»è¿‡å…±è¯†ä¹‹åæäº¤è¿™æ¡æ—¥å¿—ï¼Œå¹¶é€šçŸ¥ applyChï¼ŒKvServer ä¼šåœ¨ Apply Goruntine ä¸­å°† applyCh çš„æ¶ˆæ¯è§£ç ï¼Œç„¶åå°†æ“ä½œåº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºä¸­ï¼Œæœ€åæŠŠç»“æœå†™åˆ°é€šçŸ¥å®¢æˆ·ç«¯çš„ notifyChan ä¸­ï¼Œåœ¨DoCommand ä¸­å“åº”ç»“æœç»™å®¢æˆ·ç«¯ã€‚
    </p>

      <h3>æèµ 
      </h3>

      <p>
        æ•´ç†è¿™æœ¬ä¹¦è€—è´¹äº†æˆ‘ä»¬å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ã€‚å¦‚æœä½ è§‰å¾—æœ‰å¸®åŠ©ï¼Œä¸€ç“¶çŸ¿æ³‰æ°´çš„ä»·æ ¼æ”¯æŒæˆ‘ä»¬ç»§ç»­è¾“å‡ºä¼˜è´¨çš„åˆ†å¸ƒå¼å­˜å‚¨çŸ¥è¯†ä½“ç³»ï¼Œ2.99Â¥ï¼Œæ„Ÿè°¢å¤§å®¶çš„æ”¯æŒã€‚
      </p>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/alipay.jpeg" width="200px" style="display: inline-block;"/>
      </div>

      <h3 id="license">å¼€æºåè®®<a class="anchor" href="#tags">#</a></h3>
      <p>ã€Œèµ«è¹ã€éµå¾ªMITåè®®å¼€æºã€‚</p>

      <!-- <footer class="heti-fn">
        <ol>
          <li id="fn-01">
            <a href="#ref-01" title="ç§»è‡³">^</a>
            CSS Resetï¼šæŒ‡ä»£ç±»ä¼¼Eric Meyer's Reset CSSçš„æ ·å¼é‡ç½®æ–¹æ¡ˆ
          </li>
          <li id="fn-02">
            <a href="#ref-02" title="ç§»è‡³">^</a>
            ã€Šä¸­æ–‡æ’ç‰ˆéœ€æ±‚ã€‹ï¼šhttps://w3c.github.io/clreq/
          </li>
          <li id="fn-03">
            <a href="#ref-03" title="ç§»è‡³">^</a>
            åœ¨å½“ä¸‹å‰ç«¯æŠ€æœ¯å°šä¸èƒ½å®Œç¾è§£å†³ä¸­è¥¿æ–‡æ··æ’é—´è·çš„æƒ…å†µä¸‹ï¼Œå¸¸è§çš„è¾“å…¥ä¹ æƒ¯æ˜¯æ‰‹åŠ¨åœ¨ä¸­è¥¿æ–‡é—´åŠ å…¥ç©ºæ ¼ï¼ˆhttps://github.com/vinta/pangu.jsï¼‰ã€‚è¿™æ ·åšçš„å¼Šç«¯ä¸€æ˜¯é—´è·ä¸å¯æ§ï¼ˆæœ‰æ—¶æ˜¾å¾—è¿‡å¤§ï¼‰ï¼ŒäºŒæ˜¯é€šè¿‡ç©ºæ ¼ç¬¦æ¥æ’ç‰ˆåªèƒ½ç®—æ— å¥ˆä¹‹ä¸¾ã€‚å¥½æ¶ˆæ¯æ˜¯åœ¨æœ€æ–°çš„macOSã€iOSä¸­ï¼Œä½¿ç”¨åŸç”Ÿè¯­è¨€å¼€å‘çš„æ–‡æœ¬åŒºåŸŸä¼šè‡ªåŠ¨å¤„ç†ä¸­è¥¿æ–‡æ··æ’çš„é—´è·ï¼ˆæ— è®ºæ˜¯å¦åŠ ç©ºæ ¼ï¼‰ï¼ŒæœŸå¾…ä¸ç”¨æ‰‹æ•²ç©ºæ ¼çš„æ—¥å­æ—©æ—¥åˆ°æ¥ã€‚
          </li>
        </ol>
      </footer> -->
      <script src="https://giscus.app/client.js"
      data-repo="eraft-io/eraft-io.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnkzOTYyMDM3NjU="
      data-category="General"
      data-category-id="DIC_kwDOF52W9c4CRblA"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="zh-CN"
      crossorigin="anonymous"
      async>
  </script>

    </article>
  </main>




  <aside class="panel">
    <ul class="panel-list panel-list--gray">
      <li><input type="radio" class="J_fontStack" value="heti--classic" name="font" id="font-classic" checked><label for="font-classic">ä¼ ç»Ÿ</label></li>
      <li><input type="radio" class="J_fontStack" value="heti--sans" name="font" id="font-sans"><label for="font-sans">é»‘ä½“</label></li>
      <li><input type="radio" class="J_fontStack" value="heti--serif" name="font" id="font-serif"><label for="font-serif">å®‹ä½“</label></li>
    </ul>
    <ul class="panel-list panel-list--gray">
      <li><input type="radio" class="J_radioGrid" value="" name="grid" id="grid-disable" checked><label for="grid-disable">ç½‘æ ¼ï¼šå…³</label></li>
      <li><input type="radio" class="J_radioGrid" value="grid-24" name="grid" id="grid-24"><label for="grid-24">å¤§</label></li>
      <li><input type="radio" class="J_radioGrid" value="grid-12" name="grid" id="grid-12"><label for="grid-12">å°</label></li>
    </ul>
    <ul class="panel-list panel-list--gray panel-list--icon">
      <li><input type="radio" class="J_darkMode" value="auto" name="darkmode" id="darkmode-auto" checked><label for="darkmode-auto">ğŸŒ—</label></li>
      <li><input type="radio" class="J_darkMode" value="light" name="darkmode" id="darkmode-light"><label for="darkmode-light">ğŸŒ</label></li>
      <li><input type="radio" class="J_darkMode" value="dark" name="darkmode" id="darkmode-dark"><label for="darkmode-dark">ğŸŒ™</label></li>
    </ul>
  </aside>

  <script src="./heti-addon.js"></script>
  <script>
    const $$root = document.getElementsByTagName('html')[0]
    const $$main = document.getElementsByTagName('main')[0]
    const $$article = document.getElementsByTagName('article')[0]

    function addEventListeners(nodeList, event, fn) {
      [].forEach.call(nodeList, function(elm) {
        elm.addEventListener(event, fn, false)
      }, false)
    }

    addEventListeners(document.getElementsByClassName('J_darkMode'), 'change', function (e) {
      $$root.setAttribute('data-darkmode', e.target.value)
    })

    addEventListeners(document.getElementsByClassName('J_radioGrid'), 'change', function (e) {
      $$main.setAttribute('data-bg-grid', e.target.value)
    })

    addEventListeners(document.getElementsByClassName('J_fontStack'), 'change', function (e) {
      $$article.className = ['article', 'heti', e.target.value].join(' ')
    })

    const heti = new Heti('.article')
    heti.autoSpacing()
  </script>
</body>
</html>
