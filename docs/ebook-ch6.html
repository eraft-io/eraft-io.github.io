<!DOCTYPE html>
<html lang="zh-Hans" data-darkmode="auto">
<head>
  <meta charset="UTF-8">
  <title>eraftå¼€å‘ç»„ - è§£è¯»å›½å¤–ä¼˜è´¨è®¡ç®—æœºè¯¾ç¨‹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./heti.css">
  <link rel="stylesheet" href="./index.css">
  <link rel="icon" href="./favicon.svg">
</head>
<body>
  <main class="container">
    <article class="article heti heti--classic">
      <h1 class="article__title">eraftå¼€å‘ç»„</h1>
      <blockquote>

        æˆ‘ä»¬å›¢é˜Ÿè‡´åŠ›äºè§£è¯»å›½å¤–ä¼˜ç§€çš„åˆ†å¸ƒå¼å­˜å‚¨ç›¸å…³å¼€æºè¯¾ç¨‹ï¼Œä¸‹é¢æ˜¯è¯¾ç¨‹ä½“ç³»å›¾
        æˆ‘ä»¬å§‹ç»ˆåšä¿¡ä¼˜ç§€çš„æœ¬ç§‘æ•™å­¦ä¸åº”è¯¥æ˜¯ç…§æœ¬å®£ç§‘ä»¥åŠåº”ä»˜è€ƒè¯•ï¼Œä¸€é—¨ä¼˜ç§€çš„è¯¾ç¨‹ï¼Œåº”è¯¥å…·å¤‡è®©å­¦ç”Ÿå­¦ä¼šæ€è€ƒã€åŠ¨æ‰‹å®è·µã€æ‰¾åˆ°é—®é¢˜ã€åå¤è¯•é”™ã€å¹¶è§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼ŒåŒæ—¶åº”è¯¥å°½é‡ç”¨æœ€ç›´ç™½ï¼Œæœ€ç®€å•çš„è¯­è¨€ä¼ è¾¾å…³é”®çš„çŸ¥è¯†ç‚¹ã€‚ä½œä¸ºè®¡ç®—æœºå·¥ä¸šç•Œçš„å·¥ä½œè€…ï¼Œæˆ‘ç›¸ä¿¡åšè¯¾ç¨‹å’ŒåšæŠ€æœ¯ä¸€æ ·ï¼Œå¹¶ä¸æ˜¯è¶Šå¤æ‚è¶Šå¥½ï¼Œåº”è¯¥å°½é‡çš„è®©è®¾è®¡å‡ºæ¥çš„ä¸œè¥¿ç®€å•åŒ–ã€‚
        å…³æ³¨æˆ‘ä»¬çš„æœ€æ–°åŠ¨æ€ï¼Œæ¬¢è¿å…³æ³¨
         
        <a href="https://www.zhihu.com/people/liu-jie-84-52" target="_blank">https://www.zhihu.com/people/liu-jie-84-52</a>
        æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æ­£é¢˜ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿã€‚

      </blockquote>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/arch.png" width="40%" style="display: inline-block; margin-bottom: 5%;"/>
      </div>

        <details open>
          <summary></summary>
          <ol>
            <li>
              <a href="#intro">MIT6.824 åˆ†å¸ƒå¼ç³»ç»Ÿç³»åˆ—</a>
              <ul>
                <li><a href="./index.html">ï¼ˆä¸€ï¼‰ä½“éªŒåˆ†å¸ƒå¼KVå­˜å‚¨ç³»ç»Ÿeraftkv </a></li>
                <li><a href="./ebook-ch2.html">ï¼ˆäºŒï¼‰Go è¯­è¨€åŸºç¡€çŸ¥è¯†</a></li>
                <li><a href="./ebook-ch3.html">ï¼ˆä¸‰ï¼‰Raft è®ºæ–‡è§£è¯» </a></li>
                <li><a href="./ebook-ch4.html">ï¼ˆå››ï¼‰æ„å»º Raft åº“                </a></li>
                <li><a href="./ebook-ch5.html">ï¼ˆäº”ï¼‰åŸºäº Raft åº“ï¼Œå®ç°ç®€å•çš„åˆ†å¸ƒå¼ KV ç³»   </a></li>
                <li><a href="./ebook-ch6.html">ï¼ˆå…­ï¼‰Multi-Raft è®¾è®¡ä¸å®ç°   </a></li>
                <li><a href="./ebook-ch7.html">ï¼ˆä¸ƒï¼‰åˆ†å¸ƒå¼äº‹åŠ¡åˆæ¢   </a></li>
              </ul>
            </li>
          </ol>
        </details>

      <h2 id="intro"> MIT åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆå…­ï¼‰Multi-Raft è®¾è®¡ä¸å®ç° <a class="anchor" href="#intro">#</a></h2>
    
      <h3>
        è®¾è®¡æ€è€ƒ
      </h3>

      <p>
        åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬åº”ç”¨ Raft å®ç°äº†ä¸€ä¸ªå•åˆ†ç»„çš„ Raft KV é›†ç¾¤ã€‚å®¢æˆ·ç«¯å†™è¯·æ±‚åˆ° Leaderï¼ŒLeader æŠŠæ“ä½œå¤åˆ¶åˆ° Follower èŠ‚ç‚¹ã€‚å½“ Leader æŒ‚äº†ï¼Œä¼šæŒ‰æˆ‘ä»¬ç¬¬å››ç« æè¿°çš„ Raft ç®—æ³•åº“ï¼Œè¿›è¡Œä¸€è½®æ–°çš„é€‰ä¸¾ï¼Œé€‰å‡ºæ–°çš„ Leader åç»§ç»­æä¾›æœåŠ¡ã€‚è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªé«˜å¯ç”¨çš„é›†ç¾¤ã€‚
      </p>

      <p>
        æˆ‘ä»¬é€šè¿‡å•åˆ†ç»„çš„ KV é›†ç¾¤å®ç°äº†é«˜å¯ç”¨ï¼Œä»¥åŠåˆ†åŒºå®¹å¿æ€§ï¼Œä½†æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿè¿˜æœ‰ä¸€ä¸ªå¯æ‰©å±•çš„ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å †æœºå™¨çš„æ–¹å¼æ¥è®©ç³»ç»Ÿå®ç°æ›´é«˜çš„ååé‡ã€‚æˆ‘ä»¬ç¬¬äº”ç« å®ç°çš„æ˜¯å•åˆ†ç»„é›†ç¾¤ï¼Œåªæœ‰å•ä¸ª Leader èŠ‚ç‚¹æ‰¿æ‹…å®¢æˆ·ç«¯çš„å†™å…¥ã€‚å•åˆ†ç»„é›†ç¾¤ç³»ç»Ÿçš„ååé‡ä¸Šçº¿å–å†³äºå•æœºçš„æ€§èƒ½ã€‚é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°åˆ†å¸ƒå¼å¯æ‰©å±•æ€§å‘¢ï¼Ÿ
      </p>

      <p>
        æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä»‹ç» Multi-Raft å®ç°ï¼Œå®ƒå¯ä»¥è§£å†³å•åˆ†ç»„é›†ç¾¤çš„å¯æ‰©å±•æ€§é—®é¢˜ã€‚å®ƒçš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼šæ—¢ç„¶å•ç»„æœ‰ä¸Šé™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä¸å¯ä»¥ç”¨å¤šç»„ Raft KV é›†ç¾¤æ¥å®ç°æ‰©å±•å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªé…ç½®ä¸­å¿ƒæ¥ç®¡ç†å¤šä¸ªåˆ†ç»„æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯ã€‚æœ‰äº†å¤šä¸ªåˆ†ç»„ä¹‹åï¼Œæˆ‘ä»¬å°±è¦è€ƒè™‘æ€ä¹ˆæ ·æŠŠç”¨æˆ·çš„è¯·æ±‚å‡è¡¡åœ°åˆ†å‘åˆ°ç›¸åº”çš„åˆ†ç»„æœåŠ¡å™¨ä¸Šäº†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å“ˆå¸Œç®—æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯¹ç”¨æˆ·çš„ key åšå“ˆå¸Œè®¡ç®—ï¼Œç„¶åæ˜ å°„åˆ°ä¸åŒçš„æœåŠ¡åˆ†ç»„ä¸Šï¼Œè¿™æ ·å¯ä»¥ä¿è¯æµé‡çš„å‡è¡¡ã€‚
      </p>

      <p>
        æ•´åˆä¸€ä¸‹ä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ç³»ç»Ÿæ¶æ„å›¾ aï¼š
      </p>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/eraftdb_arch.png" width="80%" style="display: inline-block; margin-bottom: 5%;"/>
      </div>

      <p>
        åœ¨ç¬¬ä¸€ç« å¼€ç¯‡ï¼Œæˆ‘ä»¬ä»‹ç»äº†ç³»ç»Ÿçš„æ•´ä½“æ¶æ„å¹¶ä¸”å¸¦å¤§å®¶ä½“éªŒäº†ç³»ç»Ÿçš„è¿è¡Œã€‚ä¹‹åï¼Œæˆ‘ä»¬è®²è§£äº†Goè¯­è¨€çš„åŸºç¡€çŸ¥è¯†ã€Raft ç®—æ³•åº“ä»¥åŠåº”ç”¨ Raft ç®—æ³•åº“çš„ç¤ºä¾‹ã€‚ç›¸ä¿¡å¤§å®¶ç°åœ¨å¯¹è¿™ä¸ªç³»ç»Ÿå·²ç»æœ‰äº†ä¸€ä¸ªæ›´åŠ æ·±å…¥çš„ç†è§£ã€‚
      </p>

      <p>
        é¦–å…ˆï¼Œå®¢æˆ·ç«¯å¯åŠ¨ä¹‹åï¼Œä¼šä»é…ç½®æœåŠ¡å™¨ï¼ˆConfigServerï¼‰æ‹‰å–é›†ç¾¤çš„åˆ†ç»„ä¿¡æ¯ï¼Œä»¥åŠåˆ†ç»„è´Ÿè´£çš„æ•°æ®æ¡¶ï¼ˆBucketï¼‰ä¿¡æ¯åˆ°æœ¬åœ°ã€‚å®¢æˆ·ç«¯å‘é€è¯·æ±‚çš„æ—¶å€™ä¼šè®¡ç®— key çš„å“ˆå¸Œå€¼ï¼Œæ‰¾åˆ°ç›¸åº”çš„æ¡¶ä»¥åŠè´Ÿè´£è¿™ä¸ªæ¡¶çš„æœåŠ¡å™¨åˆ†ç»„ï¼ˆShardServerï¼‰åœ°å€ä¿¡æ¯ï¼Œç„¶åå°†æ“ä½œå‘é€åˆ°å¯¹åº”çš„æœåŠ¡å™¨åˆ†ç»„è¿›è¡Œå¤„ç†ã€‚è¿™é‡Œ ConfigServer æœåŠ¡å™¨åˆ†ç»„å’Œ ShardServer æœåŠ¡å™¨åˆ†ç»„éƒ½æ˜¯é«˜å¯ç”¨çš„ï¼Œå¤šä¸ª ShardServer å®ç°äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚
      </p>

      <h3>
        é…ç½®æœåŠ¡å™¨å®ç°åˆ†æ
      </h3>
      
      <p>
        é…ç½®æœåŠ¡çš„å®ç°åœ¨ eraft/configserver ç›®å½•ä¸‹ã€‚æ ¹æ®ä¸Šé¢çš„æ¶æ„å›¾ï¼Œæˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŸ¥é“é…ç½®æœåŠ¡å™¨éœ€è¦å­˜å‚¨å“ªäº›ä¿¡æ¯ï¼šï¼ˆ1ï¼‰æ¯ä¸ªæœåŠ¡åˆ†ç»„çš„æœåŠ¡å™¨åœ°å€ä¿¡æ¯ï¼›ï¼ˆ2ï¼‰æœåŠ¡åˆ†ç»„è´Ÿè´£çš„æ•°æ®æ¡¶ä¿¡æ¯ã€‚è¿™ä¸ªç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š
      </p>

      <blockquote>
        type Config struct {
            Version int
            Buckets [common.NBuckets]int
            Groups  map[int][]string
        }
      </blockquote>

      <p>
        Version è¡¨ç¤ºå½“å‰é…ç½®çš„ç‰ˆæœ¬å·ã€‚Buckets å­˜å‚¨äº†åˆ†ç»„è´Ÿè´£çš„æ¡¶ä¿¡æ¯ã€‚NBuckets æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­æœ€å¤§çš„æ¡¶æ•°é‡ã€‚è¿™é‡Œæˆ‘ä»¬é»˜è®¤æ˜¯ 10ã€‚å¯¹äºå¤§è§„æ¨¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œ Buckets å€¼å¯ä»¥è¢«è®¾ç½®ä¸ºå¾ˆå¤§ã€‚
      </p>

      <p>
        æˆ‘ä»¬çœ‹åˆ°ä¸‹é¢çš„é…ç½®ç¤ºä¾‹ï¼šé…ç½®ç‰ˆæœ¬å·ä¸º 6 ï¼Œ10 ä¸ªæ¡¶å’Œ1ä¸ªåˆ†ç»„æœåŠ¡ã€‚ 
      </p>

      <p>
        æˆ‘ä»¬è®¾ç½® 127.0.0.1:6088ï¼Œ127.0.0.1:6089ï¼Œ127.0.0.1:6090 è¿™ä¸‰å°æœåŠ¡å™¨ç»„æˆåˆ†ç»„ 1ã€‚Buckets æ•°ç»„ä¸­ 0-4 å·æ¡¶éƒ½æ˜¯åˆ†ç»„ 1 è´Ÿè´£çš„ã€‚5-9 å·æ¡¶ä¸º 0ï¼Œè¡¨ç¤ºå½“å‰æ²¡æœ‰åˆ†ç»„è´Ÿè´£è¿™äº›æ¡¶çš„æ•°æ®å†™å…¥ã€‚
      </p>

      <blockquote>
        {"Version":6,"Buckets":[1,1,1,1,1,0,0,0,0,0],"Groups":{"1":["127.0.0.1:6088","127.0.0.1:6089","127.0.0.1:6090"]}}
      </blockquote>

      <p>
        eraft ä¸­æŠŠä¸Šè¿°é…ç½®ä¿¡æ¯å­˜å‚¨åˆ°äº† leveldb ä¸­ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªæ“ä½œçš„æ¥å£ï¼ŒJoin æ“ä½œ æ˜¯æŠŠä¸€ä¸ªåˆ†ç»„çš„æœåŠ¡å™¨åŠ å…¥åˆ°é›†ç¾¤é…ç½®ä¸­ï¼›Leave æ“ä½œæ˜¯åˆ é™¤æŸäº›åˆ†ç»„çš„æœåŠ¡å™¨é…ç½®ä¿¡æ¯ï¼›Move æ“ä½œæ˜¯å°†æŸä¸ªæ¡¶åˆ†é…ç»™ç›¸åº”çš„åˆ†ç»„è´Ÿè´£ï¼›Query æ“ä½œæ˜¯æŸ¥è¯¢é…ç½®ä¿¡æ¯ã€‚è¿™äº›æ“ä½œæ˜¯é€šè¿‡ä¿®æ”¹ Config è¿™ä¸ªç»“æ„ï¼Œå¹¶å°†æ•°æ®æŒä¹…åŒ–åˆ° leveldb ä¸­å®ç°ã€‚æ“ä½œçš„ä»£ç å®ç°é€»è¾‘åœ¨ eraft/configserver/config_stm.go é‡Œé¢ã€‚
      </p>

      <blockquote>
        type ConfigStm interface { <br/>
            Join(groups map[int][]string) error<br/>
            Leave(gids []int) error<br/>
            Move(bucket_id, gid int) error<br/>
            Query(num int) (Config, error)<br/>
        }<br/>
      </blockquote>

      <p>
        é…ç½®æœåŠ¡å™¨çš„æ ¸å¿ƒé€»è¾‘åœ¨ config_server.go é‡Œé¢ï¼Œå¯ä»¥çœ‹åˆ°å’Œæˆ‘ä»¬ç¬¬å››ç« å®ç°çš„å•åˆ†ç»„ kv æå…¶ç±»ä¼¼ã€‚è¿™é‡Œåªæ˜¯æŠŠ Put, Get æ“ä½œç»™æ”¹æˆäº†å¯¹é…ç½®çš„ Joinã€Leaveã€Moveã€Query æ“ä½œã€‚ æ¯ä¸€æ¬¡æ“ä½œéƒ½ç»è¿‡ä¸€æ¬¡å…±è¯†ï¼Œä¿è¯ä¸‰ä¸ªæœåŠ¡èŠ‚ç‚¹éƒ½æœ‰ä¸€è‡´çš„é…ç½®ã€‚è¿™æ · Leader é…ç½®èŠ‚ç‚¹æŒ‚æ‰åï¼Œé›†ç¾¤ä¸­ä»ç„¶å¯ä»¥ä»æ–°çš„ Leader é…ç½®æœåŠ¡å™¨ä¸­è·å–é…ç½®ä¿¡æ¯ã€‚

      </p>


      <h3>
        åˆ†ç‰‡æœåŠ¡å™¨å®ç°åˆ†æ

      </h3>

      <p>
        é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹åˆ° bucket å®šä¹‰å¦‚ä¸‹ï¼š
      </p>

      <blockquote>
        // a bucket is a logical partition in a distributed system <br/>
        //  it has a unique id, a pointer to db engine, and status<br/>
        //<br/>
        type Bucket struct {<br/>
            ID     int<br/>
            KvDB   storage_eng.KvStore<br/>
            Status buketStatus<br/>
        }<br/>
      </blockquote>

      <p>
        æ¡¶å…·æœ‰ä¸€ä¸ªå”¯ä¸€æ ‡è¯†çš„ IDã€‚ å‰é¢æˆ‘ä»¬ä»‹ç»é…ç½®æœåŠ¡å™¨çš„æ—¶ï¼Œä»‹ç»è¿‡ä¸€ä¸ªæœåŠ¡åˆ†ç»„è´Ÿè´£ä¸€éƒ¨åˆ†æ¡¶çš„æ•°æ®ã€‚åœ¨é…ç½®æœåŠ¡å™¨ä¸­ï¼Œ1Â·æ¡¶å…³è”çš„ ID å€¼å°±æ˜¯é…ç½®æ•°ç»„çš„ç´¢å¼•å·ã€‚ åŒæ—¶ï¼Œæ¡¶è¿˜å…³è”äº†ä¸€ä¸ª KvStore çš„æ¥å£ã€‚æˆ‘ä»¬å†™æ•°æ®çš„æ—¶å€™ä¼šä¼ å…¥å½“å‰æœåŠ¡å™¨æŒæœ‰çš„æ•°æ®å­˜å‚¨å¼•æ“ï¼Œä¸‹é¢æ˜¯å¯¹æ¡¶ä¸­æ•°æ®çš„æ“ä½œï¼Œæœ‰ Get, Put, Appendã€‚
      </p>

      <blockquote>

        // <br/>
        // get encode key data from engine<br/>
        //<br/>
        func (bu *Bucket) Get(key string) (string, error) {<br/>
            encodeKey := strconv.Itoa(bu.ID) + SPLIT + key<br/>
            v, err := bu.KvDB.Get(encodeKey)<br/>
            if err != nil {<br/>
                return "", err<br/>
            }<br/>
            return v, nil<br/>
        }
        <br/><br/>
        //<br/>
        // put key, value data to db engine<br/>
        //<br/>
        func (bu *Bucket) Put(key, value string) error {<br/>
            encodeKey := strconv.Itoa(bu.ID) + SPLIT + key<br/>
            return bu.KvDB.Put(encodeKey, value)<br/>
        }<br/>
        <br/>
        //<br/>
        // appned data  to engine<br/>
        //<br/>
        func (bu *Bucket) Append(key, value string) error {<br/>
            oldV, err := bu.Get(key)<br/>
            if err != nil {<br/>
                return err<br/>
            }<br/>
            return bu.Put(key, oldV+value)<br/>
        }<br/>
        <br/>
      </blockquote>

      <p>
        æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹ ShardServer å®šä¹‰çš„ç»“æ„ä½“
      </p>

      <blockquote>
        type ShardKV struct {<br/>
            mu      sync.RWMutex<br/>
            dead    int32<br/>
            rf      *raftcore.Raft<br/>
            applyCh chan *pb.ApplyMsg<br/>
            gid_    int<br/>
            cvCli   *configserver.CfgCli<br/>
        
            lastApplied int<br/>
            lastConfig  configserver.Config<br/>
            curConfig   configserver.Config<br/>
        
            stm map[int]*Bucket<br/>
        
            dbEng storage_eng.KvStore<br/>
        
            notifyChans map[int]chan *pb.CommandResponse<br/>
        
            stopApplyCh chan interface{}<br/>
        
            pb.UnimplementedRaftServiceServer<br/>
        } <br/>
      </blockquote>

      <p>
        è¿™ä¸ªç»“æ„å’Œæˆ‘ä»¬åº”ç”¨ Raft å®ç°å•ç»„ KvServer çš„ç»“æ„ç‰¹åˆ«ç±»ä¼¼ã€‚è¿™é‡Œçš„çŠ¶æ€æœºæ˜¯ map[int]*Bucket ç±»å‹çš„ï¼Œä»£è¡¨å½“å‰æœåŠ¡å™¨çš„æ¡¶çš„æ•°æ®ã€‚åˆ†ç‰‡æœåŠ¡å™¨éœ€è¦å’Œé…ç½®æœåŠ¡å™¨äº¤äº’ï¼ŒçŸ¥é“è‡ªå·±è´Ÿè´£å“ªäº›åˆ†ç‰‡çš„æ•°æ®ã€‚cvCli å®šä¹‰äº†åˆ°é…ç½®æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ã€‚lastConfigï¼ŒcurConfig åˆ†åˆ«è®°å½•äº†ä¸Šä¸€ä¸ªç‰ˆæœ¬ä»¥åŠå½“å‰ç‰ˆæœ¬çš„é›†ç¾¤é…ç½®è¡¨ã€‚æœåŠ¡å™¨çŸ¥é“è¿™ä¸ªè¡¨ä¹‹åå°±çŸ¥é“è‡ªå·±è´Ÿè´£å“ªäº›åˆ†ç‰‡çš„æ•°æ®ã€‚å½“é›†ç¾¤æ‹“æ‰‘å˜æ›´åï¼Œé…ç½®è¡¨ä¼šå˜åŒ–ï¼Œåˆ†ç‰‡æœåŠ¡å™¨èƒ½ç¬¬ä¸€æ—¶é—´æ„ŸçŸ¥åˆ°å˜åŒ–ï¼Œå¹¶ä¸”åº”ç”¨æ–°çš„é…ç½®è¡¨ã€‚å…¶ä»–ç»“æ„å°±å’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»å•ç»„ KvServer ä¸€æ ·äº†ã€‚
      </p>

      <p>
        æˆ‘ä»¬çœ‹çœ‹ ShardServer æ„é€ æµç¨‹å’Œå•ç»„ KvServer çš„åŒºåˆ«ã€‚é¦–å…ˆï¼Œ Server å¯åŠ¨çš„æ—¶å€™æˆ‘ä»¬åˆå§‹åŒ–äº†ä¸¤ä¸ªå¼•æ“ï¼Œä¸€ä¸ªç”¨æ¥å­˜å‚¨ Raft æ—¥å¿—çš„ logDbEngï¼Œå¦ä¸€ä¸ªç”¨æ¥å­˜å‚¨å®é™…æ•°æ®çš„ newdbEngã€‚cvCli æ˜¯åˆ°é…ç½®æœåŠ¡å™¨åˆ†ç»„çš„è¿æ¥å®¢æˆ·ã€‚ï¼Œæˆ‘ä»¬è°ƒç”¨ MakeCfgSvrClient æ„é€ åˆ°é…ç½®æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œä¼ å…¥é…ç½®æœåŠ¡å™¨åˆ†ç»„çš„åœ°å€åˆ—è¡¨ã€‚
      </p>

      <blockquote>
//<br/>
// MakeShardKVServer make a new shard kv server<br/>
// peerMaps: init peer map in the raft group<br/>
// nodeId: the peer's nodeId in the raft group<br/>
// gid: the node's raft group id<br/>
// configServerAddr: config server addr (leader addr, need to optimized into config server peer map)<br/>
//<br/>
func MakeShardKVServer(peerMaps map[int]string, nodeId int, gid int, configServerAddrs string) *ShardKV {<br/>
    ...<br/>

	logDbEng := storage_eng.EngineFactory("leveldb", "./log_data/shard_svr/group_"+strconv.Itoa(gid)+"/node_"+strconv.Itoa(nodeId))<br/>
	newRf := raftcore.MakeRaft(clientEnds, nodeId, logDbEng, newApplyCh, 500, 1500)<br/>
	newdbEng := storage_eng.EngineFactory("leveldb", "./data/group_"+strconv.Itoa(gid)+"/node_"+strconv.Itoa(nodeId))<br/>
    <br/>
	shardKv := &ShardKV{<br/>
        ...<br/>
		cvCli:       configserver.MakeCfgSvrClient(common.UN_UNSED_TID, strings.Split(configServerAddrs, ",")),<br/>
		lastApplied: 0,<br/>
		curConfig:   configserver.DefaultConfig(),<br/>
		lastConfig:  configserver.DefaultConfig(),<br/>
		stm:         make(map[int]*Bucket),<br/>
		...<br/>
	}
    <br/><br/>
	shardKv.initStm(shardKv.dbEng)<br/>

	shardKv.curConfig = *shardKv.cvCli.Query(-1)<br/>
	shardKv.lastConfig = *shardKv.cvCli.Query(-1)<br/>
    ...<br/>
    <br/>
	go shardKv.ConfigAction()<br/>
    <br/>
	return shardKv<br/>
}<br/>
      </blockquote>

      <p>
        æˆ‘ä»¬ initStm å‡½æ•°åˆå§‹åŒ–äº†çŠ¶æ€æœºé‡Œé¢çš„æ¯ä¸ª Bucketã€‚ä¹‹åï¼Œè°ƒç”¨ cvCli.Query(-1) æŸ¥è¯¢å½“å‰æœ€æ–°çš„é…ç½®ç¼“å­˜åˆ°æœ¬åœ°çš„ curConfigï¼ŒlastConfigï¼Œåˆå§‹å¯åŠ¨ï¼Œè¿™ä¸¤ä¸ªé…ç½®æ˜¯ä¸€æ ·çš„ã€‚
      </p>

      <p>
        è¿™é‡Œæœ‰ä¸€ä¸ªæ‰§è¡Œä»»åŠ¡ä¸º ConfigAction çš„ Goruntineï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå¹²äº†å•¥ã€‚ æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼Œä¸‹é¢çš„é€»è¾‘æ˜¯ä¸€ä¸ªå¾ªç¯æ‰§è¡Œçš„ï¼Œæ—¶é—´é—´éš”æ˜¯ 1sã€‚ é¦–å…ˆæˆ‘ä»¬é€šè¿‡ cvCli.Query å°è¯•æŸ¥è¯¢ä¸‹ä¸€ä¸ªé…ç½®ç‰ˆæœ¬ä¿¡æ¯ï¼Œå¦‚æœå½“å‰é›†ç¾¤æ²¡æœ‰é…ç½®å˜æ›´ï¼Œè¿”å› nilï¼Œæˆ‘ä»¬ continue è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ï¼Œå•¥ä¹Ÿä¸å¹²ã€‚
      </p>

      <p>
        å¦‚æœæœ‰æ–°çš„é…ç½®å˜æ›´ï¼Œæ¯”å¦‚åŠ å…¥äº†æ–°çš„æœåŠ¡å™¨åˆ†ç»„ï¼Œæˆ‘ä»¬å°±ä¼šå¯¹æ¯”æ–°çš„é…ç½®å’Œå½“å‰é…ç½®çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚å¦‚æœåŒ¹é…ä¸Šï¼Œå½“å‰èŠ‚ç‚¹ä½œä¸º Leader éœ€è¦æŠŠè¿™ä¸ªé…ç½®å˜åŒ–ä¿¡æ¯å‘é€åˆ°è¿™ä¸ªæœåŠ¡å™¨åˆ†ç»„ï¼Œè®©å¤§å®¶éƒ½çŸ¥é“æ–°çš„é…ç½®å˜åŒ–ã€‚åˆ†ç»„æœåŠ¡é‡Œé¢çš„æ¯ä¸ªæœåŠ¡å™¨é…ç½®éƒ½è¦æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ Propose æäº¤ä¸€ä¸ª OpType_OpConfigChange çš„ææ¡ˆã€‚
      </p>

      <blockquote>
        if _, isLeader := s.rf.GetState(); isLeader {<br/>
            ...<br/>
                nextConfig := s.cvCli.Query(int64(curConfVersion) + 1)<br/>
                if nextConfig == nil {<br/>
                    continue<br/>
                }<br/>
                nextCfBytes, _ := json.Marshal(nextConfig)<br/>
                curCfBytes, _ := json.Marshal(s.curConfig)<br/>
                raftcore.PrintDebugLog("next config -> " + string(nextCfBytes))<br/>
                raftcore.PrintDebugLog("cur config -> " + string(curCfBytes))<br/>
                if nextConfig.Version == curConfVersion+1 {<br/>
                    req := &pb.CommandRequest{}<br/>
                    nextCfBytes, _ := json.Marshal(nextConfig)<br/>
                    raftcore.PrintDebugLog("can perform next conf -> " + string(nextCfBytes))<br/>
                    req.Context = nextCfBytes<br/>
                    req.OpType = pb.OpType_OpConfigChange<br/>
                    reqBytes, _ := json.Marshal(req)<br/>
                    idx, _, isLeader := s.rf.Propose(reqBytes)<br/>
                    if !isLeader {<br/>
                        return<br/>
                    }<br/>
                    <br/>
                    ...<br/>
                }<br/>
            }<br/>
      </blockquote>

      <p>
        æœ€åæˆ‘ä»¬çœ‹çœ‹åˆ†ç»„ä¸­çš„æœåŠ¡å™¨æ˜¯æ€ä¹ˆ Apply è¿™ä¸ªæ—¥å¿—çš„
      </p>

      <blockquote>
        <pre>
nextConfig := &configserver.Config{}
json.Unmarshal(req.Context, nextConfig)
if nextConfig.Version == s.curConfig.Version+1 {
    ...
	s.lastConfig = s.curConfig
	s.curConfig = *nextConfig
	cfBytes, _ := json.Marshal(s.curConfig)
	raftcore.PrintDebugLog("applied config to server -> " + string(cfBytes))
}
        </pre>
				
      </blockquote>
<p>
    æˆ‘ä»¬ä¼šæ›´æ–° Server çš„ lastConfig å’Œ curConfig é…ç½®ä¿¡æ¯ã€‚
</p>

<h3>
    å®¢æˆ·ç«¯å®ç°åˆ†æ

</h3>

<p>
    å½“å®¢æˆ·ç«¯å†™å…¥ä¸€ä¸ª Key åˆ°ç³»ç»Ÿä¸­æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦çŸ¥é“ Key å±äºé‚£ä¸ªåˆ†ç»„æœåŠ¡å™¨è´Ÿè´£ã€‚åœ¨æ„é€ å®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå…ˆå°†æœ€æ–°çš„é…ç½®ä¿¡æ¯ç¼“å­˜åˆ°æœ¬åœ°ã€‚
</p>

<blockquote>
    <pre>
// make a kv cilent
//
func MakeKvClient(csAddrs string) *KvClient {
	...
	kvCli.config = kvCli.csCli.Query(-1)
	return kvCli
}
</pre>

</blockquote>

<p>
    å®¢æˆ·ç«¯ä¸­æˆ‘ä»¬æä¾›äº† Get(key string) å’Œ Put(key, value string) çš„æ¥å£ï¼Œå®ƒä»¬éƒ½æ˜¯è°ƒç”¨å…¬ç”¨çš„ Command æ–¹æ³•å»è®¿é—®æˆ‘ä»¬çš„åˆ†ç»„æœåŠ¡å™¨ã€‚  
</p>


<blockquote>
    <pre>
//
// Command
// do user normal command
//
func (kvCli *KvClient) Command(req *pb.CommandRequest) (string, error) {
	bucket_id := common.Key2BucketID(req.Key)
	gid := kvCli.config.Buckets[bucket_id]
	if gid == 0 {
		return "", errors.New("there is no shard in charge of this bucket, please join the server group before")
	}
	if servers, ok := kvCli.config.Groups[gid]; ok {
		for _, svrAddr := range servers {
			if kvCli.GetConnFromCache(svrAddr) == nil {
				kvCli.rpcCli = raftcore.MakeRaftClientEnd(svrAddr, common.UN_UNSED_TID)
			} else {
				kvCli.rpcCli = kvCli.GetConnFromCache(svrAddr)
			}
			resp, err := (*kvCli.rpcCli.GetRaftServiceCli()).DoCommand(context.Background(), req)
			if err != nil {
				// node down
				raftcore.PrintDebugLog("there is a node down is cluster, but we can continue with outher node")
				continue
			}
			switch resp.ErrCode {
			case common.ErrCodeNoErr:
				kvCli.commandId++
				return resp.Value, nil
			case common.ErrCodeWrongGroup:
				kvCli.config = kvCli.csCli.Query(-1)
				return "", errors.New("WrongGroup")
			case common.ErrCodeWrongLeader:
				kvCli.rpcCli = raftcore.MakeRaftClientEnd(servers[resp.LeaderId], common.UN_UNSED_TID)
				resp, err := (*kvCli.rpcCli.GetRaftServiceCli()).DoCommand(context.Background(), req)
				if err != nil {
					fmt.Printf("err %s", err.Error())
					panic(err)
				}
				if resp.ErrCode == common.ErrCodeNoErr {
					kvCli.commandId++
					return resp.Value, nil
				}
			default:
				return "", errors.New("unknow code")
			}
		}
	} else {
		return "", errors.New("please join the server group first")
	}
	return "", errors.New("unknow code")
}
</pre>
</blockquote>

<p>
1.é¦–å…ˆæˆ‘ä»¬ä¼šä½¿ç”¨ Key2BucketID å‡½æ•°å¯¹ Key åš CRC32 è¿ç®—ï¼Œå¾—åˆ°å®ƒåº”è¯¥è¢«åˆ†é…åˆ°æ¡¶çš„ IDï¼› <br/>

2.ç„¶å ä»æœ¬åœ°ç¼“å­˜çš„ kvCli.config é…ç½®é‡Œé¢æ‰¾åˆ°è´Ÿè´£è¿™ä¸ª bucket id æ•°æ®çš„æœåŠ¡å™¨åˆ†ç»„ï¼›<br/>

3.æ‹¿åˆ°æœåŠ¡å™¨åˆ†ç»„ä¹‹åï¼Œæˆ‘ä»¬ä¼šå‘ç¬¬ä¸€ä¸ªæœåŠ¡å™¨å‘é€ DoCommand RPCï¼›<br/>

4.å¦‚æœè¿™ä¸ªæœåŠ¡å™¨ä¸æ˜¯ Leaderï¼Œå®ƒä¼šè¿”å› Leader çš„ IDã€‚ç„¶åå®¢æˆ·ç«¯ä¼šé‡æ–°å‘ DoCommand RPC ç»™ Leader èŠ‚ç‚¹ã€‚<br/>
</p>

      <h3>æèµ 
      </h3>

      <p>
        æ•´ç†è¿™æœ¬ä¹¦è€—è´¹äº†æˆ‘ä»¬å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›ã€‚å¦‚æœä½ è§‰å¾—æœ‰å¸®åŠ©ï¼Œä¸€ç“¶çŸ¿æ³‰æ°´çš„ä»·æ ¼æ”¯æŒæˆ‘ä»¬ç»§ç»­è¾“å‡ºä¼˜è´¨çš„åˆ†å¸ƒå¼å­˜å‚¨çŸ¥è¯†ä½“ç³»ï¼Œ2.99Â¥ï¼Œæ„Ÿè°¢å¤§å®¶çš„æ”¯æŒã€‚
      </p>

      <div style="text-align: center; width: 100%; border: black solid 1px;">
        <img src="./resources/alipay.jpeg" width="200px" style="display: inline-block;"/>
      </div>

      <h3 id="license">å¼€æºåè®®<a class="anchor" href="#tags">#</a></h3>
      <p>ã€Œèµ«è¹ã€éµå¾ªMITåè®®å¼€æºã€‚</p>

      <!-- <footer class="heti-fn">
        <ol>
          <li id="fn-01">
            <a href="#ref-01" title="ç§»è‡³">^</a>
            CSS Resetï¼šæŒ‡ä»£ç±»ä¼¼Eric Meyer's Reset CSSçš„æ ·å¼é‡ç½®æ–¹æ¡ˆ
          </li>
          <li id="fn-02">
            <a href="#ref-02" title="ç§»è‡³">^</a>
            ã€Šä¸­æ–‡æ’ç‰ˆéœ€æ±‚ã€‹ï¼šhttps://w3c.github.io/clreq/
          </li>
          <li id="fn-03">
            <a href="#ref-03" title="ç§»è‡³">^</a>
            åœ¨å½“ä¸‹å‰ç«¯æŠ€æœ¯å°šä¸èƒ½å®Œç¾è§£å†³ä¸­è¥¿æ–‡æ··æ’é—´è·çš„æƒ…å†µä¸‹ï¼Œå¸¸è§çš„è¾“å…¥ä¹ æƒ¯æ˜¯æ‰‹åŠ¨åœ¨ä¸­è¥¿æ–‡é—´åŠ å…¥ç©ºæ ¼ï¼ˆhttps://github.com/vinta/pangu.jsï¼‰ã€‚è¿™æ ·åšçš„å¼Šç«¯ä¸€æ˜¯é—´è·ä¸å¯æ§ï¼ˆæœ‰æ—¶æ˜¾å¾—è¿‡å¤§ï¼‰ï¼ŒäºŒæ˜¯é€šè¿‡ç©ºæ ¼ç¬¦æ¥æ’ç‰ˆåªèƒ½ç®—æ— å¥ˆä¹‹ä¸¾ã€‚å¥½æ¶ˆæ¯æ˜¯åœ¨æœ€æ–°çš„macOSã€iOSä¸­ï¼Œä½¿ç”¨åŸç”Ÿè¯­è¨€å¼€å‘çš„æ–‡æœ¬åŒºåŸŸä¼šè‡ªåŠ¨å¤„ç†ä¸­è¥¿æ–‡æ··æ’çš„é—´è·ï¼ˆæ— è®ºæ˜¯å¦åŠ ç©ºæ ¼ï¼‰ï¼ŒæœŸå¾…ä¸ç”¨æ‰‹æ•²ç©ºæ ¼çš„æ—¥å­æ—©æ—¥åˆ°æ¥ã€‚
          </li>
        </ol>
      </footer> -->
      <script src="https://giscus.app/client.js"
      data-repo="eraft-io/eraft-io.github.io"
      data-repo-id="MDEwOlJlcG9zaXRvcnkzOTYyMDM3NjU="
      data-category="General"
      data-category-id="DIC_kwDOF52W9c4CRblA"
      data-mapping="pathname"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="bottom"
      data-theme="preferred_color_scheme"
      data-lang="zh-CN"
      crossorigin="anonymous"
      async>
  </script>

    </article>
  </main>




  <aside class="panel">
    <ul class="panel-list panel-list--gray">
      <li><input type="radio" class="J_fontStack" value="heti--classic" name="font" id="font-classic" checked><label for="font-classic">ä¼ ç»Ÿ</label></li>
      <li><input type="radio" class="J_fontStack" value="heti--sans" name="font" id="font-sans"><label for="font-sans">é»‘ä½“</label></li>
      <li><input type="radio" class="J_fontStack" value="heti--serif" name="font" id="font-serif"><label for="font-serif">å®‹ä½“</label></li>
    </ul>
    <ul class="panel-list panel-list--gray">
      <li><input type="radio" class="J_radioGrid" value="" name="grid" id="grid-disable" checked><label for="grid-disable">ç½‘æ ¼ï¼šå…³</label></li>
      <li><input type="radio" class="J_radioGrid" value="grid-24" name="grid" id="grid-24"><label for="grid-24">å¤§</label></li>
      <li><input type="radio" class="J_radioGrid" value="grid-12" name="grid" id="grid-12"><label for="grid-12">å°</label></li>
    </ul>
    <ul class="panel-list panel-list--gray panel-list--icon">
      <li><input type="radio" class="J_darkMode" value="auto" name="darkmode" id="darkmode-auto" checked><label for="darkmode-auto">ğŸŒ—</label></li>
      <li><input type="radio" class="J_darkMode" value="light" name="darkmode" id="darkmode-light"><label for="darkmode-light">ğŸŒ</label></li>
      <li><input type="radio" class="J_darkMode" value="dark" name="darkmode" id="darkmode-dark"><label for="darkmode-dark">ğŸŒ™</label></li>
    </ul>
  </aside>

  <script src="./heti-addon.js"></script>
  <script>
    const $$root = document.getElementsByTagName('html')[0]
    const $$main = document.getElementsByTagName('main')[0]
    const $$article = document.getElementsByTagName('article')[0]

    function addEventListeners(nodeList, event, fn) {
      [].forEach.call(nodeList, function(elm) {
        elm.addEventListener(event, fn, false)
      }, false)
    }

    addEventListeners(document.getElementsByClassName('J_darkMode'), 'change', function (e) {
      $$root.setAttribute('data-darkmode', e.target.value)
    })

    addEventListeners(document.getElementsByClassName('J_radioGrid'), 'change', function (e) {
      $$main.setAttribute('data-bg-grid', e.target.value)
    })

    addEventListeners(document.getElementsByClassName('J_fontStack'), 'change', function (e) {
      $$article.className = ['article', 'heti', e.target.value].join(' ')
    })

    const heti = new Heti('.article')
    heti.autoSpacing()
  </script>
</body>
</html>
